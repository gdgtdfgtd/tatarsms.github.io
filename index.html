<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tatarsms | Private P2P</title>
    
    <!-- Подключаем иконки и шрифты -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PeerJS для P2P связи -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-darker: #202225;
            --bg-sidebar: #2f3136;
            --bg-main: #36393f;
            --accent: #5865f2;
            --accent-hover: #4752c4;
            --text-white: #ffffff;
            --text-muted: #b9bbbe;
            --danger: #ed4245;
            --success: #3ba55d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-darker); color: var(--text-white); overflow: hidden; height: 100vh; }

        /* --- ОКНО ВХОДА (AUTH SCREEN) --- */
        #auth-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #2f3136 0%, #202225 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: 0.5s ease;
        }

        .auth-card {
            background: var(--bg-main);
            width: 420px;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            text-align: center;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-card h1 { font-size: 26px; margin-bottom: 8px; color: var(--text-white); }
        .auth-card p { color: var(--text-muted); margin-bottom: 25px; font-size: 14px; }

        .input-group { text-align: left; margin-bottom: 20px; }
        .input-group label { display: block; color: var(--text-muted); font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
        .input-group input {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid transparent;
            padding: 12px;
            color: white;
            border-radius: 4px;
            outline: none;
            transition: 0.2s;
        }
        .input-group input:focus { border-color: var(--accent); }

        .btn-login {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-login:hover { background: var(--accent-hover); }

        .role-tabs { display: flex; background: var(--bg-darker); border-radius: 4px; padding: 4px; margin-bottom: 20px; }
        .role-tab { flex: 1; padding: 8px; font-size: 13px; color: var(--text-muted); cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .role-tab.active { background: #4f545c; color: white; }

        /* --- ГЛАВНЫЙ ИНТЕРФЕЙС --- */
        #app { display: flex; height: 100vh; opacity: 1; }
        .hidden { display: none !important; }

        /* Боковая панель */
        .sidebar { width: 300px; background: var(--bg-sidebar); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.2); font-weight: 700; display: flex; align-items: center; justify-content: space-between; }
        
        .contact-list { flex: 1; overflow-y: auto; padding: 10px; }
        .contact-item {
            display: flex; align-items: center; gap: 12px; padding: 10px;
            border-radius: 4px; cursor: pointer; transition: 0.2s; margin-bottom: 2px;
        }
        .contact-item:hover { background: rgba(255,255,255,0.05); }
        .contact-item.active { background: #4f545c; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #555; }

        /* Область чата */
        .main-chat { flex: 1; background: var(--bg-main); display: flex; flex-direction: column; }
        .chat-top { height: 50px; padding: 0 20px; border-bottom: 1px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 8px; line-height: 1.4; position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg.sent { align-self: flex-end; background: var(--accent); color: white; }
        .msg.received { align-self: flex-start; background: var(--bg-sidebar); }
        .msg-info { font-size: 11px; margin-bottom: 4px; opacity: 0.7; }

        .input-area { padding: 20px; background: var(--bg-main); }
        .input-container { background: #40444b; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; }
        #message-input { flex: 1; background: none; border: none; padding: 12px; color: white; outline: none; }
        .action-btn { color: var(--text-muted); cursor: pointer; font-size: 18px; margin: 0 5px; transition: 0.2s; }
        .action-btn:hover { color: white; }

        /* Модалки */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-main); padding: 30px; border-radius: 8px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .blue-tick { color: #00a8fc; margin-left: 5px; }

        /* Звонки */
        .video-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin: 20px 0; background: #000; height: 250px; border-radius: 8px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 80px; height: 60px; position: absolute; bottom: 10px; right: 10px; border: 2px solid white; border-radius: 4px; }
    </style>
</head>
<body>

    <!-- ОКНО РЕГИСТРАЦИИ И ВХОДА -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1>tatarsms</h1>
            <p>Мессенджер без серверов (P2P)</p>
            
            <div class="role-tabs">
                <div id="tab-user" class="role-tab active" onclick="switchRole('user')">Пользователь</div>
                <div id="tab-admin" class="role-tab" onclick="switchRole('admin')">Админ</div>
            </div>

            <div class="input-group">
                <label>Ваш Никнейм (ID для связи)</label>
                <input type="text" id="login-id" placeholder="Напр: tatar_ivan">
            </div>

            <div id="admin-field" class="input-group hidden">
                <label>Пароль Администратора</label>
                <input type="password" id="login-pass">
            </div>

            <button class="btn-login" onclick="startSession()">Войти в систему</button>
            <div id="auth-status" style="margin-top: 15px; font-size: 12px; color: var(--danger);"></div>
        </div>
    </div>

    <!-- ОСНОВНОЙ ИНТЕРФЕЙС -->
    <div id="app" class="hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span>Чаты</span>
                <i class="fas fa-cog" style="cursor:pointer" onclick="openSettings()"></i>
            </div>
            <div style="padding: 10px;">
                <input type="text" id="search-peer" placeholder="Найти друга по ID..." style="width:100%; background:var(--bg-darker); border:none; padding:8px; border-radius:4px; color:white; outline:none;">
            </div>
            <div class="contact-list" id="contact-list">
                <!-- Контакты -->
            </div>
            <div style="padding: 15px; background: rgba(0,0,0,0.1); font-size: 13px;">
                Мой ID: <strong id="display-my-id">...</strong>
            </div>
        </aside>

        <main class="main-chat">
            <div id="no-chat" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted);">
                <i class="fas fa-comments" style="font-size: 50px; margin-bottom: 10px;"></i>
                <p>Выберите чат или введите ID друга</p>
            </div>

            <div id="chat-active" class="hidden" style="flex:1; display:flex; flex-direction:column;">
                <div class="chat-top">
                    <div>
                        <strong id="chat-title">User</strong>
                        <span id="chat-badge"></span>
                    </div>
                    <div>
                        <i class="fas fa-phone action-btn" onclick="makeCall(false)"></i>
                        <i class="fas fa-video action-btn" onclick="makeCall(true)"></i>
                    </div>
                </div>
                <div class="messages" id="messages"></div>
                <div class="input-area">
                    <div class="input-container">
                        <i class="far fa-smile action-btn"></i>
                        <input type="text" id="message-input" placeholder="Написать сообщение...">
                        <i class="fas fa-paper-plane action-btn" onclick="sendMsg()"></i>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- МОДАЛКИ -->
    <div id="modal-overlay" class="overlay hidden">
        <!-- Настройки -->
        <div id="modal-settings" class="modal hidden">
            <h2 style="margin-bottom:20px;">Настройки</h2>
            <p style="font-size:14px; margin-bottom:10px;">Верификация: <span id="verif-status">Нет</span></p>
            <button class="btn-login" style="margin-bottom:10px;" onclick="alert('Отправьте видео на daniil.kokorin6858569@gmail.com для получения галочки.')">Как верифицироваться?</button>
            
            <div id="admin-panel" class="hidden" style="border-top: 1px dotted #555; padding-top:15px; margin-top:10px;">
                <p style="color:var(--accent); font-size:12px; margin-bottom:5px;">АДМИН: Выдать верификацию</p>
                <input type="text" id="target-id" placeholder="ID пользователя" style="width:100%; background:var(--bg-darker); border:none; padding:8px; color:white; margin-bottom:10px;">
                <button class="btn-login" style="background:var(--success)" onclick="adminVerify()">Выдать галочку</button>
            </div>
            
            <button class="btn-login" style="background:#555; margin-top:15px;" onclick="closeModals()">Закрыть</button>
        </div>

        <!-- Звонок -->
        <div id="modal-call" class="modal hidden" style="text-align:center;">
            <h2 id="call-label">Звонок...</h2>
            <div class="video-grid">
                <video id="remote-video" autoplay playsinline></video>
                <video id="local-video" autoplay muted playsinline></video>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-answer" class="btn-login" style="background:var(--success)">Ответить</button>
                <button class="btn-login" style="background:var(--danger)" onclick="endCall()">Завершить</button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_ID = "tatar_506";
        const ADMIN_PASS = "spinogrz666";

        let state = {
            id: '',
            role: 'user',
            verified: false,
            peer: null,
            activeChat: null,
            friends: JSON.parse(localStorage.getItem('tat_friends') || '[]'),
            history: JSON.parse(localStorage.getItem('tat_history') || '{}'),
            localStream: null,
            currentCall: null
        };

        // Переключение ролей
        function switchRole(role) {
            state.role = role;
            document.getElementById('tab-user').classList.toggle('active', role === 'user');
            document.getElementById('tab-admin').classList.toggle('active', role === 'admin');
            document.getElementById('admin-field').classList.toggle('hidden', role === 'user');
        }

        // Вход
        function startSession() {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value.trim();

            if (!id) return alert("Введите ID!");
            if (state.role === 'admin') {
                if (id !== ADMIN_ID || pass !== ADMIN_PASS) return alert("Неверный логин/пароль админа");
                state.verified = true;
            }

            state.id = id;
            initPeer();
        }

        function initPeer() {
            const status = document.getElementById('auth-status');
            status.innerText = "Подключение к сети P2P...";

            state.peer = new Peer(state.id);

            state.peer.on('open', () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('display-my-id').innerText = state.id;
                renderFriends();
            });

            state.peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    status.innerText = "Этот никнейм уже занят!";
                } else {
                    status.innerText = "Ошибка сети. Попробуйте другой ник.";
                }
            });

            // Входящие сообщения
            state.peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    if (data.type === 'msg') {
                        addHistory(conn.peer, data.text, 'received');
                        if (!state.friends.includes(conn.peer)) {
                            state.friends.push(conn.peer);
                            localStorage.setItem('tat_friends', JSON.stringify(state.friends));
                            renderFriends();
                        }
                        if (state.activeChat === conn.peer) renderMessages();
                    } else if (data.type === 'verify') {
                        state.verified = true;
                        alert("Вы получили статус верификации!");
                    }
                });
            });

            // Входящие звонки
            state.peer.on('call', (call) => {
                state.currentCall = call;
                openCallModal("Входящий вызов...");
                document.getElementById('btn-answer').classList.remove('hidden');
                document.getElementById('btn-answer').onclick = async () => {
                    state.localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                    document.getElementById('local-video').srcObject = state.localStream;
                    call.answer(state.localStream);
                    call.on('stream', stream => {
                        document.getElementById('remote-video').srcObject = stream;
                    });
                    document.getElementById('btn-answer').classList.add('hidden');
                };
            });
        }

        function sendMsg() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !state.activeChat) return;

            const conn = state.peer.connect(state.activeChat);
            conn.on('open', () => {
                conn.send({ type: 'msg', text: text });
                addHistory(state.activeChat, text, 'sent');
                renderMessages();
                input.value = '';
            });
        }

        function addHistory(peerId, text, type) {
            if (!state.history[peerId]) state.history[peerId] = [];
            state.history[peerId].push({ text, type, time: Date.now() });
            localStorage.setItem('tat_history', JSON.stringify(state.history));
        }

        function renderFriends() {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            state.friends.forEach(f => {
                const div = document.createElement('div');
                div.className = `contact-item ${state.activeChat === f ? 'active' : ''}`;
                div.onclick = () => selectChat(f);
                div.innerHTML = `<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${f}" class="avatar"> <span>${f}</span>`;
                list.appendChild(div);
            });
        }

        function selectChat(id) {
            state.activeChat = id;
            document.getElementById('no-chat').classList.add('hidden');
            document.getElementById('chat-active').classList.remove('hidden');
            document.getElementById('chat-title').innerText = id;
            renderFriends();
            renderMessages();
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            const msgs = state.history[state.activeChat] || [];
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type}`;
                div.innerHTML = `<div class="msg-info">${m.type === 'sent' ? 'Вы' : state.activeChat}</div>${m.text}`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // Звонки
        async function makeCall(video) {
            try {
                state.localStream = await navigator.mediaDevices.getUserMedia({video: video, audio: true});
                document.getElementById('local-video').srcObject = state.localStream;
                openCallModal("Вызов...");
                document.getElementById('btn-answer').classList.add('hidden');
                
                const call = state.peer.call(state.activeChat, state.localStream);
                state.currentCall = call;
                call.on('stream', stream => {
                    document.getElementById('remote-video').srcObject = stream;
                });
            } catch (e) { alert("Нет доступа к камере"); }
        }

        function endCall() {
            if (state.currentCall) state.currentCall.close();
            if (state.localStream) state.localStream.getTracks().forEach(t => t.stop());
            closeModals();
        }

        // Поиск друга
        document.getElementById('search-peer').onkeypress = (e) => {
            if (e.key === 'Enter') {
                const val = e.target.value.trim();
                if (val && val !== state.id) {
                    if (!state.friends.includes(val)) {
                        state.friends.push(val);
                        localStorage.setItem('tat_friends', JSON.stringify(state.friends));
                    }
                    selectChat(val);
                    e.target.value = '';
                }
            }
        };

        // Сообщение по Enter
        document.getElementById('message-input').onkeypress = (e) => { if (e.key === 'Enter') sendMsg(); };

        // Модалки
        function openSettings() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-settings').classList.remove('hidden');
            document.getElementById('verif-status').innerText = state.verified ? "Верифицирован ✅" : "Нет";
            if (state.role === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
        }

        function openCallModal(text) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-call').classList.remove('hidden');
            document.getElementById('call-label').innerText = text;
        }

        function closeModals() {
            document.querySelectorAll('.overlay, .modal').forEach(m => m.classList.add('hidden'));
        }

        function adminVerify() {
            const tid = document.getElementById('target-id').value.trim();
            if (!tid) return;
            const conn = state.peer.connect(tid);
            conn.on('open', () => {
                conn.send({ type: 'verify' });
                alert("Галочка отправлена!");
            });
        }
    </script>
</body>
</html>
