<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tatarsms | P2P Messenger</title>
    
    <!-- Внешние зависимости -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        /* --- ДИЗАЙН В СТИЛЕ DISCORD (DARK THEME) --- */
        :root {
            --bg-darker: #202225;
            --bg-sidebar: #2f3136;
            --bg-main: #36393f;
            --accent: #5865f2;
            --accent-hover: #4752c4;
            --text-white: #ffffff;
            --text-muted: #b9bbbe;
            --success: #3ba55d;
            --danger: #ed4245;
            --glass: rgba(0, 0, 0, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-darker); color: var(--text-white); overflow: hidden; height: 100vh; }

        /* Анимации */
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(88, 101, 242, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(88, 101, 242, 0); }
            100% { box-shadow: 0 0 0 0 rgba(88, 101, 242, 0); }
        }

        #app { display: flex; height: 100vh; width: 100vw; }

        /* Боковая панель */
        .sidebar { display: flex; width: 320px; background: var(--bg-sidebar); border-right: 1px solid rgba(0,0,0,0.2); }
        
        .nav-rail { width: 72px; background: var(--bg-darker); display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 12px; }
        .nav-item { width: 48px; height: 48px; background: var(--bg-main); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.25s; color: var(--text-muted); position: relative; }
        .nav-item:hover, .nav-item.active { border-radius: 15px; background: var(--accent); color: white; }
        .nav-divider { width: 32px; height: 2px; background: var(--bg-main); border-radius: 1px; }

        .contact-list { flex: 1; display: flex; flex-direction: column; }
        .search-area { padding: 15px; }
        .search-input { width: 100%; background: var(--bg-darker); border: none; padding: 8px 12px; border-radius: 4px; color: white; outline: none; font-size: 14px; }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 0 8px; }
        .contact-card { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; cursor: pointer; margin-bottom: 2px; transition: 0.2s; animation: slideIn 0.3s ease; }
        .contact-card:hover { background: rgba(255,255,255,0.05); }
        .contact-card.active { background: rgba(79, 84, 92, 0.4); color: white; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; position: relative; }
        .online-badge { width: 10px; height: 10px; background: var(--success); border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid var(--bg-sidebar); }

        /* Основная область чата */
        .chat-container { flex: 1; background: var(--bg-main); display: flex; flex-direction: column; position: relative; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.2); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .messages-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 70%; animation: fadeIn 0.3s ease; }
        .msg.sent { align-self: flex-end; }
        .msg-content { padding: 10px 14px; border-radius: 8px; background: var(--bg-sidebar); font-size: 15px; line-height: 1.4; position: relative; }
        .sent .msg-content { background: var(--accent); color: white; }
        .msg-author { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; }
        .blue-tick { color: #00a8fc; margin-left: 4px; font-size: 14px; }

        /* Ввод сообщения */
        .input-bar { padding: 20px; position: relative; }
        .input-box { background: #40444b; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; }
        #message-input { flex: 1; background: none; border: none; padding: 12px 0; color: white; outline: none; }
        .input-actions { display: flex; gap: 15px; color: var(--text-muted); }
        .input-actions i { cursor: pointer; transition: 0.2s; }
        .input-actions i:hover { color: white; }

        /* Стикеры */
        .sticker-panel { position: absolute; bottom: 80px; left: 20px; width: 300px; background: var(--bg-sidebar); border-radius: 8px; border: 1px solid var(--bg-darker); padding: 12px; z-index: 100; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        .sticker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; }
        .sticker-grid img { width: 100%; cursor: pointer; transition: 0.2s; }
        .sticker-grid img:hover { transform: scale(1.1); }

        /* Модальные окна */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-main); width: 420px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .modal h2 { margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .form-group input { width: 100%; background: var(--bg-darker); border: none; padding: 12px; color: white; border-radius: 4px; outline: none; }
        .btn { border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; color: white; }
        .btn-primary { background: var(--accent); width: 100%; }
        .btn-primary:hover { background: var(--accent-hover); }

        /* Регистрация */
        .auth-container { position: fixed; inset: 0; background: var(--bg-darker); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .auth-card { background: var(--bg-sidebar); padding: 40px; border-radius: 8px; width: 450px; text-align: center; }
        .role-switch { display: flex; background: var(--bg-darker); border-radius: 4px; padding: 4px; margin-bottom: 20px; }
        .role-btn { flex: 1; padding: 8px; cursor: pointer; border-radius: 4px; font-size: 14px; transition: 0.2s; }
        .role-btn.active { background: var(--accent); color: white; }

        /* Звонки */
        .call-modal { text-align: center; }
        .pulse-avatar { width: 100px; height: 100px; border-radius: 50%; background: var(--accent); margin: 0 auto 20px; animation: pulse 1.5s infinite; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .video-box { background: #000; border-radius: 8px; overflow: hidden; position: relative; margin: 20px 0; height: 240px; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 70px; position: absolute; bottom: 10px; right: 10px; border-radius: 4px; border: 2px solid white; }
        .call-actions { display: flex; gap: 20px; justify-content: center; }
        .btn-call { width: 56px; height: 56px; border-radius: 50%; font-size: 20px; }
        .btn-accept { background: var(--success); }
        .btn-decline { background: var(--danger); }

        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--bg-darker); border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Экран входа/регистрации -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-card">
            <h1 style="margin-bottom: 8px;">tatarsms</h1>
            <p style="color: var(--text-muted); margin-bottom: 25px;">Добро пожаловать обратно!</p>
            
            <div class="role-switch">
                <div id="role-user" class="role-btn active" onclick="setRole('user')">Пользователь</div>
                <div id="role-admin" class="role-btn" onclick="setRole('admin')">Администратор</div>
            </div>

            <div class="form-group">
                <label>Твой никнейм (ID)</label>
                <input type="text" id="login-id" placeholder="Например: tatar_ivan">
            </div>
            <div id="admin-pass-field" class="form-group hidden">
                <label>Пароль админа</label>
                <input type="password" id="admin-pass">
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Войти</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <!-- Левая панель -->
        <aside class="sidebar">
            <div class="nav-rail">
                <div class="nav-item active" onclick="switchMode('dm')"><i class="fas fa-comment-dots"></i></div>
                <div class="nav-item" onclick="switchMode('group')"><i class="fas fa-users"></i></div>
                <div class="nav-divider"></div>
                <div class="nav-item" onclick="openModal('create-group')"><i class="fas fa-plus"></i></div>
            </div>
            
            <div class="contact-list">
                <div class="search-area">
                    <input type="text" id="user-search" class="search-input" placeholder="Найти по нику...">
                </div>
                <div class="scroll-area" id="contact-list-items">
                    <!-- Контакты загружаются здесь -->
                </div>
                <!-- Нижняя инфо-панель -->
                <div style="padding: 10px; background: rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="openModal('settings')">
                    <img id="my-avatar" src="" class="avatar">
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-size: 14px; font-weight: 600;" id="my-name-display">Name</div>
                        <div style="font-size: 12px; color: var(--text-muted);">#<span id="my-id-display">ID</span></div>
                    </div>
                    <i class="fas fa-cog"></i>
                </div>
            </div>
        </aside>

        <!-- Чат -->
        <main class="chat-container">
            <div id="empty-chat" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color: var(--text-muted);">
                <i class="fas fa-comments" style="font-size: 60px; margin-bottom: 15px; opacity: 0.2;"></i>
                <h2>tatarsms P2P</h2>
                <p>Выберите чат, чтобы начать общение</p>
            </div>

            <div id="active-chat-ui" class="hidden" style="flex:1; display:flex; flex-direction:column;">
                <header class="chat-header">
                    <div>
                        <span style="font-weight: 700;" id="chat-with-name">Nickname</span>
                        <span id="chat-with-badge"></span>
                    </div>
                    <div class="input-actions" style="font-size: 18px;">
                        <i class="fas fa-phone" onclick="startCall(false)"></i>
                        <i class="fas fa-video" onclick="startCall(true)"></i>
                    </div>
                </header>

                <div class="messages-box" id="messages-display"></div>

                <div class="input-bar">
                    <div id="sticker-panel" class="sticker-panel hidden">
                        <div class="sticker-grid" id="sticker-grid-content"></div>
                        <input type="text" id="custom-sticker-url" placeholder="URL картинки" class="search-input" style="margin-top:10px;">
                        <button class="btn btn-primary" style="padding: 5px; margin-top: 5px;" onclick="addCustomSticker()">Добавить</button>
                    </div>
                    <div class="input-box">
                        <div class="input-actions" style="margin-right: 15px;">
                            <i class="far fa-sticky-note" onclick="toggleStickers()"></i>
                        </div>
                        <input type="text" id="message-input" placeholder="Написать сообщение...">
                        <div class="input-actions" style="margin-left: 15px;">
                            <i class="fas fa-paper-plane" onclick="sendMessage()"></i>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Модалки -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <!-- Настройки -->
        <div id="modal-settings" class="modal hidden">
            <h2>Настройки</h2>
            <div class="form-group">
                <label>Аватар (URL)</label>
                <input type="text" id="set-avatar-url">
            </div>
            <div style="background: var(--bg-darker); padding: 15px; border-radius: 4px;">
                <p style="font-size: 14px;">Статус верификации: <span id="verif-status-text">Обычный</span></p>
                <button class="btn btn-primary" style="margin-top: 10px;" onclick="showVerifyInstructions()">Получить галочку</button>
            </div>
            <div id="admin-panel" class="hidden" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                <label style="color: var(--accent);">АДМИН: Выдать верификацию</label>
                <input type="text" id="admin-target-id" placeholder="ID пользователя" class="search-input" style="margin: 10px 0;">
                <button class="btn btn-primary" onclick="adminGiveBadge()">Выдать синий чек</button>
            </div>
            <button class="btn btn-primary" style="margin-top: 20px; background: #555;" onclick="closeModals()">Закрыть</button>
        </div>

        <!-- Создание группы -->
        <div id="modal-create-group" class="modal hidden">
            <h2>Создать канал</h2>
            <div class="form-group">
                <label>Название канала</label>
                <input type="text" id="group-name-input" placeholder="Моя банда">
            </div>
            <p style="font-size: 12px; color: var(--text-muted);">В P2P версии каналы работают как локальные комнаты.</p>
            <button class="btn btn-primary" onclick="createGroupAction()">Создать</button>
            <button class="btn btn-primary" style="margin-top: 10px; background: #555;" onclick="closeModals()">Отмена</button>
        </div>

        <!-- Звонок -->
        <div id="modal-call" class="modal hidden call-modal">
            <div id="call-init">
                <div class="pulse-avatar"><i class="fas fa-user"></i></div>
                <h2 id="call-partner-name">Звонок...</h2>
                <div class="call-actions">
                    <button id="call-accept" class="btn btn-call btn-accept"><i class="fas fa-phone"></i></button>
                    <button id="call-decline" class="btn btn-call btn-decline"><i class="fas fa-phone-slash"></i></button>
                </div>
            </div>
            <div id="call-active" class="hidden">
                <div class="video-box">
                    <video id="remote-video" autoplay playsinline></video>
                    <video id="local-video" autoplay muted playsinline></video>
                </div>
                <button class="btn btn-decline" style="width: 100%;" onclick="endCall()">Завершить</button>
            </div>
        </div>
    </div>

    <script>
        // --- КОНФИГ ---
        const ADMIN_ID = "tatar_506";
        const ADMIN_PASS = "spinogrz666";

        let state = {
            me: { id: '', role: 'user', avatar: '', verified: false },
            activePeer: null,
            mode: 'dm',
            friends: JSON.parse(localStorage.getItem('tat_friends') || '[]'),
            groups: JSON.parse(localStorage.getItem('tat_groups') || '[]'),
            history: JSON.parse(localStorage.getItem('tat_history') || '{}'),
            stickers: JSON.parse(localStorage.getItem('tat_stickers') || []),
            peer: null,
            currentCall: null,
            localStream: null
        };

        // --- ЛОГИКА ВХОДА ---
        function setRole(role) {
            state.me.role = role;
            document.getElementById('role-user').classList.toggle('active', role === 'user');
            document.getElementById('role-admin').classList.toggle('active', role === 'admin');
            document.getElementById('admin-pass-field').classList.toggle('hidden', role === 'user');
        }

        function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('admin-pass').value.trim();

            if (!id) return alert("Введите ID!");
            if (state.me.role === 'admin' && (id !== ADMIN_ID || pass !== ADMIN_PASS)) {
                return alert("Ошибка доступа администратора!");
            }

            state.me.id = id;
            state.me.avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${id}`;
            if (state.me.role === 'admin') state.me.verified = true;

            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            initPeer();
            updateUI();
        }

        // --- P2P СВЯЗЬ ---
        function initPeer() {
            state.peer = new Peer(state.me.id);

            state.peer.on('open', (id) => {
                document.getElementById('my-id-display').innerText = id;
                document.getElementById('my-name-display').innerText = id;
                document.getElementById('my-avatar').src = state.me.avatar;
            });

            state.peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    if (data.type === 'msg') {
                        receiveMessage(conn.peer, data.text);
                    } else if (data.type === 'verify_badge') {
                        state.me.verified = true;
                        updateUI();
                    }
                });
            });

            state.peer.on('call', (call) => {
                state.currentCall = call;
                openModal('call');
                document.getElementById('call-init').classList.remove('hidden');
                document.getElementById('call-active').classList.add('hidden');
                document.getElementById('call-partner-name').innerText = call.peer;

                document.getElementById('call-accept').onclick = async () => {
                    state.localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                    document.getElementById('local-video').srcObject = state.localStream;
                    call.answer(state.localStream);
                    handleStream(call);
                };
            });
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !state.activePeer) return;

            const conn = state.peer.connect(state.activePeer);
            conn.on('open', () => {
                conn.send({ type: 'msg', text: text });
                saveMessage(state.activePeer, text, 'sent');
                input.value = '';
                renderMessages();
            });
        }

        function receiveMessage(senderId, text) {
            saveMessage(senderId, text, 'received');
            if (!state.friends.includes(senderId)) {
                state.friends.push(senderId);
                localStorage.setItem('tat_friends', JSON.stringify(state.friends));
                renderContactList();
            }
            if (state.activePeer === senderId) renderMessages();
        }

        function saveMessage(chatId, text, type) {
            if (!state.history[chatId]) state.history[chatId] = [];
            state.history[chatId].push({ text, type, time: Date.now() });
            localStorage.setItem('tat_history', JSON.stringify(state.history));
        }

        // --- ЗВОНКИ ---
        async function startCall(video) {
            try {
                state.localStream = await navigator.mediaDevices.getUserMedia({video: video, audio: true});
                document.getElementById('local-video').srcObject = state.localStream;
                openModal('call');
                document.getElementById('call-init').classList.add('hidden');
                document.getElementById('call-active').classList.remove('hidden');

                const call = state.peer.call(state.activePeer, state.localStream);
                handleStream(call);
            } catch (e) { alert("Камера недоступна"); }
        }

        function handleStream(call) {
            state.currentCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('call-init').classList.add('hidden');
                document.getElementById('call-active').classList.remove('hidden');
                document.getElementById('remote-video').srcObject = remoteStream;
            });
        }

        function endCall() {
            if (state.currentCall) state.currentCall.close();
            if (state.localStream) state.localStream.getTracks().forEach(t => t.stop());
            closeModals();
        }

        // --- ИНТЕРФЕЙС ---
        function updateUI() {
            renderContactList();
            renderStickers();
            if (state.me.role === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
            if (state.me.verified) document.getElementById('verif-status-text').innerHTML = 'Верифицирован <i class="fas fa-check-circle blue-tick"></i>';
        }

        function renderContactList() {
            const container = document.getElementById('contact-list-items');
            container.innerHTML = '';
            const list = state.mode === 'dm' ? state.friends : state.groups;

            list.forEach(id => {
                const div = document.createElement('div');
                div.className = `contact-card ${state.activePeer === id ? 'active' : ''}`;
                div.onclick = () => selectChat(id);
                div.innerHTML = `
                    <div class="avatar">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${id}" style="width:100%;border-radius:50%">
                        <div class="online-badge"></div>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:14px; font-weight:600">${id}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectChat(id) {
            state.activePeer = id;
            document.getElementById('empty-chat').classList.add('hidden');
            document.getElementById('active-chat-ui').classList.remove('hidden');
            document.getElementById('chat-with-name').innerText = id;
            renderMessages();
            renderContactList();
        }

        function renderMessages() {
            const container = document.getElementById('messages-display');
            container.innerHTML = '';
            const msgs = state.history[state.activePeer] || [];
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type}`;
                div.innerHTML = `
                    <span class="msg-author">${m.type === 'sent' ? 'Вы' : state.activePeer}</span>
                    <div class="msg-content">${m.text}</div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function switchMode(m) {
            state.mode = m;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderContactList();
        }

        function toggleStickers() {
            document.getElementById('sticker-panel').classList.toggle('hidden');
        }

        function renderStickers() {
            const grid = document.getElementById('sticker-grid-content');
            grid.innerHTML = '';
            const def = [
                'https://fonts.gstatic.com/s/e/notoemoji/latest/1f600/512.gif',
                'https://fonts.gstatic.com/s/e/notoemoji/latest/1f602/512.gif',
                'https://fonts.gstatic.com/s/e/notoemoji/latest/1f525/512.gif'
            ];
            [...def, ...state.stickers].forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    const stText = `<img src="${url}" style="width:100px; display:block;">`;
                    const input = document.getElementById('message-input');
                    input.value = stText;
                    sendMessage();
                    toggleStickers();
                };
                grid.appendChild(img);
            });
        }

        function addCustomSticker() {
            const url = document.getElementById('custom-sticker-url').value;
            if (url) {
                state.stickers.push(url);
                localStorage.setItem('tat_stickers', JSON.stringify(state.stickers));
                renderStickers();
            }
        }

        // --- МОДАЛКИ ---
        function openModal(id) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-' + id).classList.remove('hidden');
        }

        function closeModals() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        }

        function showVerifyInstructions() {
            alert("Для верификации отправьте видео с лицом и фразой 'tatarsms verify' на daniil.kokorin6858569@gmail.com. Администратор активирует ваш статус.");
        }

        function adminGiveBadge() {
            const tid = document.getElementById('admin-target-id').value.trim();
            if (!tid) return;
            const conn = state.peer.connect(tid);
            conn.on('open', () => {
                conn.send({ type: 'verify_badge' });
                alert("Верификация отправлена пользователю " + tid);
            });
        }

        function createGroupAction() {
            const name = document.getElementById('group-name-input').value.trim();
            if (name) {
                state.groups.push(name);
                localStorage.setItem('tat_groups', JSON.stringify(state.groups));
                closeModals();
                renderContactList();
            }
        }

        // Поиск по Enter
        document.getElementById('user-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const id = e.target.value.trim();
                if (id && id !== state.me.id) {
                    if (!state.friends.includes(id)) {
                        state.friends.push(id);
                        localStorage.setItem('tat_friends', JSON.stringify(state.friends));
                    }
                    selectChat(id);
                    e.target.value = '';
                }
            }
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
