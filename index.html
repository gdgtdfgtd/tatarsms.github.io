<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tatarsms | Cyber P2P Edition</title>
    
    <!-- Библиотеки -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-deep: #0b0c10;
            --bg-side: #1f2833;
            --bg-chat: #0b0c10;
            --accent: #66fcf1;
            --accent-dark: #45a29e;
            --text: #c5c6c7;
            --glass: rgba(31, 40, 51, 0.8);
            --danger: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-deep); color: var(--text); height: 100vh; overflow: hidden; }

        /* --- AUTH --- */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg-deep);
            display: flex; align-items: center; justify-content: center; z-index: 10000;
            background-image: radial-gradient(circle at center, #1f2833 0%, #0b0c10 100%);
        }
        .auth-card {
            background: var(--glass); padding: 40px; border-radius: 20px;
            width: 400px; border: 1px solid var(--accent-dark); text-align: center;
            backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(102, 252, 241, 0.2);
        }
        .auth-card h1 { font-family: 'Orbitron', sans-serif; color: var(--accent); margin-bottom: 20px; letter-spacing: 5px; }
        
        /* --- LAYOUT --- */
        #app { display: flex; height: 100vh; }
        .nav-rail { width: 80px; background: var(--bg-deep); border-right: 1px solid #333; display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px; }
        .rail-btn { width: 50px; height: 50px; border-radius: 12px; background: var(--bg-side); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: var(--accent-dark); font-size: 20px; }
        .rail-btn:hover, .rail-btn.active { background: var(--accent); color: var(--bg-deep); box-shadow: 0 0 15px var(--accent); }

        .sidebar { width: 300px; background: var(--bg-side); display: flex; flex-direction: column; }
        .sidebar-head { padding: 25px; font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--accent); border-bottom: 1px solid rgba(102, 252, 241, 0.1); }
        
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        .chat-header { height: 70px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* --- MESSAGES --- */
        .messages { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .msg { max-width: 60%; animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .msg.sent { align-self: flex-end; }
        .msg-bubble { padding: 12px 18px; border-radius: 15px; background: var(--bg-side); border: 1px solid rgba(255,255,255,0.1); }
        .sent .msg-bubble { background: var(--accent-dark); color: white; border: none; }
        
        /* --- MEDIA --- */
        .media-preview { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--accent); }
        .voice-msg { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .voice-visualizer { width: 100px; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* --- INPUT --- */
        .input-area { padding: 25px; background: transparent; }
        .input-box { 
            background: var(--bg-side); border-radius: 15px; display: flex; align-items: center; 
            padding: 10px 20px; border: 1px solid rgba(102, 252, 241, 0.2); transition: 0.3s;
        }
        .input-box:focus-within { border-color: var(--accent); box-shadow: 0 0 15px rgba(102, 252, 241, 0.1); }
        #message-input { flex: 1; background: none; border: none; color: white; outline: none; padding: 10px; }
        
        .tool-btn { color: var(--accent-dark); cursor: pointer; font-size: 18px; margin: 0 10px; transition: 0.2s; }
        .tool-btn:hover { color: var(--accent); transform: scale(1.2); }
        .tool-btn.recording { color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- CLOUD PANEL --- */
        .cloud-panel { width: 350px; background: var(--bg-side); border-left: 1px solid #333; display: flex; flex-direction: column; transition: 0.3s; }
        .cloud-header { padding: 20px; font-family: 'Orbitron', sans-serif; border-bottom: 1px solid #333; }
        .file-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .file-item { aspect-ratio: 1; background: var(--bg-deep); border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid #444; }
        .file-item img, .file-item video { width: 100%; height: 100%; object-fit: cover; }

        /* --- BUTTONS --- */
        .btn-cyber {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 12px 25px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron', sans-serif;
            text-transform: uppercase; transition: 0.3s; width: 100%; margin-top: 15px;
        }
        .btn-cyber:hover { background: var(--accent); color: var(--bg-deep); box-shadow: 0 0 20px var(--accent); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Вход -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1>TATARSMS</h1>
            <p style="font-size: 12px; margin-bottom: 20px; color: var(--accent-dark);">SECURE P2P ECOSYSTEM</p>
            <input type="text" id="login-id" placeholder="ENTER NICKNAME" class="btn-cyber" style="text-align: center; text-transform: none;">
            <div id="admin-box" class="hidden">
                <input type="password" id="admin-pass" placeholder="ADMIN PASSWORD" class="btn-cyber" style="text-align: center; margin-top: 10px;">
            </div>
            <button class="btn-cyber" onclick="app.start()">INITIALIZE</button>
            <p onclick="app.toggleAdmin()" style="margin-top: 20px; font-size: 10px; cursor: pointer;">ADMIN ACCESS</p>
        </div>
    </div>

    <div id="app" class="hidden">
        <nav class="nav-rail">
            <div class="rail-btn active" onclick="ui.tab('chat')"><i class="fas fa-comment-alt"></i></div>
            <div class="rail-btn" onclick="ui.tab('cloud')"><i class="fas fa-hdd"></i></div>
            <div class="rail-btn" onclick="ui.tab('users')"><i class="fas fa-users"></i></div>
            <div style="flex:1"></div>
            <div class="rail-btn" onclick="ui.openSettings()"><i class="fas fa-cog"></i></div>
        </nav>

        <aside class="sidebar">
            <div class="sidebar-head">TERMINAL / <span id="my-id-display">USER</span></div>
            <div id="contact-list" style="padding: 10px;"></div>
        </aside>

        <main class="chat-main">
            <header class="chat-header">
                <div id="chat-target-info">
                    <h2 id="active-user-name" style="font-family: 'Orbitron'; font-size: 18px; color: var(--accent);">SELECT CHANNEL</h2>
                </div>
                <div class="chat-tools">
                    <i class="fas fa-video tool-btn" onclick="calls.start(true)"></i>
                    <i class="fas fa-phone tool-btn" onclick="calls.start(false)"></i>
                </div>
            </header>

            <div class="messages" id="message-container"></div>

            <div class="input-area">
                <div class="input-box">
                    <label for="file-upload"><i class="fas fa-paperclip tool-btn"></i></label>
                    <input type="file" id="file-upload" hidden onchange="files.handle(this)">
                    
                    <input type="text" id="message-input" placeholder="Type encrypted message...">
                    
                    <i class="fas fa-microphone tool-btn" id="voice-btn" onmousedown="voice.start()" onmouseup="voice.stop()"></i>
                    <i class="fas fa-google tool-btn" onclick="drive.upload()" title="Send to Google Drive"></i>
                    <i class="fas fa-paper-plane tool-btn" onclick="app.sendMessage()"></i>
                </div>
            </div>
        </main>

        <!-- Медиа Сервер -->
        <div class="cloud-panel" id="cloud-panel">
            <div class="cloud-header">MEDIA STORAGE</div>
            <div class="file-grid" id="cloud-grid">
                <!-- Файлы будут тут -->
            </div>
            <div style="padding: 20px;">
                <button class="btn-cyber" style="font-size: 10px;" onclick="drive.sync()">SYNC WITH GOOGLE DRIVE</button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_ID = "tatar_506";
        const ADMIN_PASS = "spinogrz666";

        let state = {
            id: '',
            peer: null,
            activePeer: null,
            friends: JSON.parse(localStorage.getItem('cyber_friends') || '[]'),
            history: JSON.parse(localStorage.getItem('cyber_history') || '{}'),
            media: JSON.parse(localStorage.getItem('cyber_media') || '[]'),
            isRecording: false,
            recorder: null,
            chunks: []
        };

        const app = {
            toggleAdmin() {
                document.getElementById('admin-box').classList.toggle('hidden');
            },
            start() {
                const id = document.getElementById('login-id').value.trim();
                if(!id) return alert("ENTER ID");
                
                state.id = id;
                state.peer = new Peer(id);
                
                state.peer.on('open', () => {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('my-id-display').innerText = id;
                    ui.renderContacts();
                    ui.renderCloud();
                });

                state.peer.on('connection', conn => {
                    conn.on('data', data => this.handleData(data, conn.peer));
                });

                state.peer.on('call', call => calls.incoming(call));
            },

            sendMessage() {
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                if(!text || !state.activePeer) return;
                
                this.sendData({ type: 'text', content: text });
                input.value = '';
            },

            sendData(data) {
                const conn = state.peer.connect(state.activePeer);
                conn.on('open', () => {
                    conn.send(data);
                    this.saveLocal(state.activePeer, data, 'sent');
                });
            },

            handleData(data, sender) {
                this.saveLocal(sender, data, 'received');
                if(!state.friends.includes(sender)) {
                    state.friends.push(sender);
                    localStorage.setItem('cyber_friends', JSON.stringify(state.friends));
                    ui.renderContacts();
                }
                if(data.type === 'file' || data.type === 'voice') {
                    state.media.push(data.content);
                    localStorage.setItem('cyber_media', JSON.stringify(state.media));
                    ui.renderCloud();
                }
                ui.renderMessages();
            },

            saveLocal(peer, data, type) {
                if(!state.history[peer]) state.history[peer] = [];
                state.history[peer].push({ ...data, type, time: new Date().toLocaleTimeString() });
                localStorage.setItem('cyber_history', JSON.stringify(state.history));
                ui.renderMessages();
            }
        };

        const ui = {
            tab(name) {
                document.getElementById('cloud-panel').style.transform = name === 'cloud' ? 'translateX(0)' : 'translateX(100%)';
            },
            renderContacts() {
                const list = document.getElementById('contact-list');
                list.innerHTML = state.friends.map(f => `
                    <div class="rail-btn" style="width: 100%; margin-bottom: 10px; font-size: 12px;" onclick="ui.selectChat('${f}')">
                        ${f.substring(0, 8)}
                    </div>
                `).join('');
            },
            selectChat(id) {
                state.activePeer = id;
                document.getElementById('active-user-name').innerText = id;
                this.renderMessages();
            },
            renderMessages() {
                if(!state.activePeer) return;
                const container = document.getElementById('message-container');
                const msgs = state.history[state.activePeer] || [];
                
                container.innerHTML = msgs.map(m => {
                    let content = m.content;
                    if(m.type_media === 'image') content = `<img src="${m.content}" class="media-preview">`;
                    if(m.type_media === 'video') content = `<video src="${m.content}" controls class="media-preview"></video>`;
                    if(m.type_media === 'voice') content = `<div class="voice-msg"><i class="fas fa-play"></i> Voice Message <audio src="${m.content}" controls></audio></div>`;

                    return `
                        <div class="msg ${m.type}">
                            <div class="msg-bubble">${content}</div>
                            <small style="font-size: 8px; opacity: 0.5;">${m.time}</small>
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            },
            renderCloud() {
                const grid = document.getElementById('cloud-grid');
                grid.innerHTML = state.media.map(m => {
                    if(m.startsWith('data:image')) return `<div class="file-item"><img src="${m}"></div>`;
                    if(m.startsWith('data:video')) return `<div class="file-item"><video src="${m}"></video></div>`;
                    return `<div class="file-item" style="display:flex; align-items:center; justify-content:center;"><i class="fas fa-file"></i></div>`;
                }).join('');
            }
        };

        const files = {
            handle(input) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const type = file.type.startsWith('image') ? 'image' : (file.type.startsWith('video') ? 'video' : 'file');
                    app.sendData({ type: 'text', type_media: type, content: e.target.result });
                    state.media.push(e.target.result);
                    localStorage.setItem('cyber_media', JSON.stringify(state.media));
                    ui.renderCloud();
                };
                reader.readAsDataURL(file);
            }
        };

        const voice = {
            async start() {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.recorder = new MediaRecorder(stream);
                state.chunks = [];
                state.recorder.ondataavailable = e => state.chunks.push(e.data);
                state.recorder.onstop = () => {
                    const blob = new Blob(state.chunks, { type: 'audio/ogg; codecs=opus' });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        app.sendData({ type: 'text', type_media: 'voice', content: e.target.result });
                    };
                    reader.readAsDataURL(blob);
                };
                state.recorder.start();
                document.getElementById('voice-btn').classList.add('recording');
            },
            stop() {
                state.recorder.stop();
                document.getElementById('voice-btn').classList.remove('recording');
            }
        };

        const drive = {
            upload() {
                alert("ИНТЕГРАЦИЯ: Файл подготовлен. Для реальной отправки на Google Drive необходимо настроить OAuth2 Client ID в консоли Google Cloud. В текущей P2P версии файл отправлен напрямую собеседнику.");
            },
            sync() {
                alert("GOOGLE CLOUD SYNC: Ожидание авторизации...");
            }
        };

        const calls = {
            async start(video) {
                const stream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
                const call = state.peer.call(state.activePeer, stream);
                // Тут можно добавить UI для звонка
            },
            incoming(call) {
                if(confirm("INCOMING CALL FROM " + call.peer)) {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                        call.answer(stream);
                    });
                }
            }
        };

        // Поиск контактов
        document.getElementById('message-input').onkeypress = (e) => {
            if(e.key === 'Enter') app.sendMessage();
        };

        // Глобальный поиск ника
        window.addEventListener('keydown', (e) => {
            if(e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                const id = prompt("ENTER PEER ID TO CONNECT:");
                if(id) {
                    state.activePeer = id;
                    if(!state.friends.includes(id)) {
                        state.friends.push(id);
                        localStorage.setItem('cyber_friends', JSON.stringify(state.friends));
                        ui.renderContacts();
                    }
                    ui.selectChat(id);
                }
            }
        });
    </script>
</body>
</html>
