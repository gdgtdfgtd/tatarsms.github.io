<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VORTEX | Cyber Ultimate</title>
    
    <!-- Ресурсы -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary: #00f2ff;
            --primary-dark: #0062ff;
            --secondary: #ff0055;
            --glass: rgba(10, 10, 15, 0.75);
            --glass-border: rgba(0, 242, 255, 0.15);
            --bg-deep: #020203;
            --text-glow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-deep); color: white; height: 100vh; overflow: hidden; }

        /* --- ЖИВОЙ ФОН С ЧАСТИЦАМИ --- */
        .cyber-bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at 50% 50%, #0a0a15 0%, #000 100%);
        }
        .grid-overlay {
            position: fixed; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: gridMove 20s linear infinite;
        }
        @keyframes gridMove { 0% { transform: translateY(0); } 100% { transform: translateY(30px); } }

        .hidden { display: none !important; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); animation: fadeIn 0.3s; }
        
        /* --- АНИМАЦИИ --- */
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes msgUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes neonPulse { 0% { box-shadow: 0 0 5px var(--primary); } 50% { box-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary); } 100% { box-shadow: 0 0 5px var(--primary); } }

        /* --- VPN ЗАГРУЗКА --- */
        .vpn-container { text-align: center; width: 320px; }
        .vpn-icon { font-size: 60px; color: var(--primary); animation: neonPulse 2s infinite; margin-bottom: 20px; }
        .loader-bar { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; position: relative; }
        .loader-fill { width: 0%; height: 100%; background: var(--primary); box-shadow: 0 0 15px var(--primary); transition: width 0.1s linear; }

        /* --- UI КОМПОНЕНТЫ --- */
        .glass-panel {
            background: var(--glass); border: 1px solid var(--glass-border);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .input-cyber {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            padding: 14px; border-radius: 12px; color: white; font-family: 'Outfit';
            transition: 0.3s; margin-bottom: 12px;
        }
        .input-cyber:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }

        .btn-cyber {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            background: linear-gradient(90deg, var(--primary), var(--accent-dark));
            color: white; font-weight: 800; letter-spacing: 1px; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; position: relative; overflow: hidden;
        }
        .btn-cyber:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--primary); }
        .btn-cyber:active { transform: scale(0.98); }

        /* --- АВТОРИЗАЦИЯ --- */
        .auth-box { width: 90%; max-width: 420px; padding: 40px; text-align: center; animation: pop 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .logo-text { font-family: 'Orbitron'; font-size: 32px; color: var(--primary); margin-bottom: 30px; text-shadow: var(--text-glow); }

        /* --- САЙДБАР --- */
        #app { display: flex; height: 100vh; width: 100vw; }
        #sidebar { 
            width: 340px; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; 
            background: rgba(5, 5, 10, 0.6); backdrop-filter: blur(30px); transition: 0.4s; z-index: 100;
        }
        
        .header-bar { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); }
        .my-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar-wrap { position: relative; }
        .my-avatar { width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; background: #000; }
        .status-dot { width: 12px; height: 12px; background: #00ff88; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid #000; }
        
        .nav-tabs { display: flex; background: rgba(255,255,255,0.05); margin: 15px; padding: 5px; border-radius: 12px; }
        .nav-tab { flex: 1; text-align: center; padding: 8px; font-size: 12px; color: #888; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .nav-tab.active { background: var(--primary-dark); color: white; }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { 
            display: flex; align-items: center; gap: 12px; padding: 14px; border-radius: 16px; 
            margin-bottom: 6px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .chat-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .chat-item.active { background: linear-gradient(90deg, rgba(0, 98, 255, 0.2), transparent); border-left: 3px solid var(--primary); }
        
        /* --- ЧАТ --- */
        #chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: rgba(0,0,0,0.2); }
        .chat-top { height: 70px; padding: 0 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        
        .msg-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .msg-row { display: flex; flex-direction: column; max-width: 75%; animation: msgUp 0.3s ease; }
        .msg-row.sent { align-self: flex-end; align-items: flex-end; }
        
        .msg-box { 
            padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; 
            background: rgba(30, 30, 40, 0.8); border: 1px solid var(--glass-border); position: relative;
        }
        .sent .msg-box { background: rgba(0, 98, 255, 0.3); border-color: var(--primary-dark); border-bottom-right-radius: 4px; }
        .received .msg-box { border-bottom-left-radius: 4px; }
        
        /* Media */
        .media-prev { max-width: 260px; border-radius: 12px; margin: 5px 0; border: 1px solid var(--glass-border); cursor: pointer; transition: 0.3s; }
        .media-prev:hover { transform: scale(1.02); }
        audio { height: 35px; width: 220px; margin-top: 5px; filter: invert(1) hue-rotate(180deg); }

        /* Input */
        .chat-bottom { padding: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        .input-row { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 25px; border: 1px solid var(--glass-border); }
        .input-row input { flex: 1; background: none; border: none; padding: 12px; color: white; font-size: 16px; }
        .tool-icon { font-size: 20px; color: #aaa; padding: 8px; cursor: pointer; transition: 0.2s; }
        .tool-icon:hover { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .recording { color: var(--secondary) !important; animation: pulse 1s infinite; }

        /* --- MODALS --- */
        .modal-box { position: relative; width: 95%; max-width: 450px; text-align: center; }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #666; }
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 10px; text-align: left; margin-top: 20px; }
        .setting-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Video Call */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; flex-direction: column; }
        .v-remote { flex: 1; width: 100%; object-fit: cover; }
        .v-local { width: 120px; height: 160px; position: absolute; bottom: 100px; right: 20px; border-radius: 15px; border: 2px solid var(--primary); object-fit: cover; box-shadow: 0 10px 30px black; }
        .call-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .btn-round { width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 24px; color: white; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }

        @media (max-width: 768px) {
            #sidebar { position: fixed; inset: 0; z-index: 500; transform: translateX(0); }
            #sidebar.closed { transform: translateX(-100%); }
            .back-btn { display: block !important; }
        }
        .back-btn { display: none; font-size: 22px; cursor: pointer; margin-right: 15px; }

        @keyframes pulse { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="cyber-bg"></div>
    <div class="grid-overlay"></div>

    <!-- 1. VPN LOADER -->
    <div id="loader" class="overlay">
        <div class="vpn-container">
            <i class="fas fa-fingerprint vpn-icon"></i>
            <h2 style="font-family: 'Orbitron'">VORTEX SECURE</h2>
            <div class="loader-bar"><div id="load-fill" class="loader-fill"></div></div>
            <p id="load-text" style="margin-top:10px; font-size:10px; color:var(--primary); letter-spacing:3px">ESTABLISHING CONNECTION...</p>
        </div>
    </div>

    <!-- 2. AUTH -->
    <div id="auth-screen" class="overlay hidden">
        <div class="auth-card glass-panel auth-box">
            <h1 class="logo-text">VORTEX</h1>
            
            <!-- Login -->
            <div id="form-login">
                <input id="l-id" class="input-cyber" placeholder="ID Пользователя">
                <input id="l-pw" type="password" class="input-cyber" placeholder="Пароль">
                <button class="btn-cyber" onclick="auth.login()">ВХОД В СИСТЕМУ</button>
                <p style="margin-top:20px; font-size:13px; color:#888; cursor:pointer" onclick="auth.view('reg')">Создать аккаунт</p>
            </div>

            <!-- Reg -->
            <div id="form-reg" class="hidden">
                <input id="r-mail" class="input-cyber" placeholder="Gmail">
                <input id="r-id" class="input-cyber" placeholder="Придумайте ID">
                <input id="r-pw" type="password" class="input-cyber" placeholder="Пароль">
                
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:10px;">
                    <p id="captcha-label" style="font-size:12px; margin-bottom:5px; color:var(--primary)"></p>
                    <input id="r-cap" class="input-cyber" placeholder="Решите пример" style="margin:0">
                </div>

                <button id="btn-code" class="btn-cyber" onclick="auth.sendCode()">ПОЛУЧИТЬ КОД</button>
                <p style="margin-top:20px; font-size:13px; color:#888; cursor:pointer" onclick="auth.view('login')">Назад</p>
            </div>

            <!-- Code -->
            <div id="form-code" class="hidden">
                <p style="margin-bottom:20px; color:var(--primary)">Код отправлен на почту</p>
                <input id="r-code" class="input-cyber" style="text-align:center; font-size:24px; letter-spacing:5px" maxlength="6">
                <button class="btn-cyber" onclick="auth.verify()">ПОДТВЕРДИТЬ</button>
            </div>
        </div>
    </div>

    <!-- 3. APP INTERFACE -->
    <div id="app" class="hidden">
        <aside id="sidebar">
            <div class="side-head">
                <div class="me-profile" onclick="ui.modal('settings')">
                    <div class="avatar-wrap">
                        <img id="my-av" src="">
                        <div id="my-status-dot" class="status-dot"></div>
                    </div>
                    <div style="display:flex; flex-direction:column">
                        <span id="my-id" style="font-weight:700">...</span>
                        <span style="font-size:11px; color:#888">Online</span>
                    </div>
                </div>
                <div style="display:flex; gap:15px; font-size:18px; color:#aaa">
                    <i class="fas fa-cog" style="cursor:pointer" onclick="ui.modal('settings')"></i>
                </div>
            </div>

            <div style="padding:15px">
                <input id="search" class="input-cyber" placeholder="Поиск (ID / Группа)..." onkeypress="msg.search(event)" style="margin:0">
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" id="tab-dm" onclick="ui.tab('dm')">ЛИЧНЫЕ</div>
                <div class="nav-tab" id="tab-gr" onclick="ui.tab('gr')">ГРУППЫ</div>
            </div>

            <div id="contacts" class="chat-list"></div>
        </aside>

        <main id="chat-area">
            <div id="welcome" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.3">
                <i class="fas fa-fingerprint" style="font-size:100px; margin-bottom:20px"></i>
                <h2>VORTEX SECURE</h2>
            </div>

            <div id="chat-active" class="hidden" style="flex:1; display:flex; flex-direction:column; height:100%">
                <header class="chat-top">
                    <div style="display:flex; align-items:center">
                        <i class="fas fa-chevron-left back-btn" onclick="ui.closeChat()"></i>
                        <img id="head-av" src="" style="width:40px; height:40px; border-radius:50%; margin-right:12px; border:1px solid var(--primary)">
                        <h4 id="head-name">User</h4>
                    </div>
                    <div style="display:flex; gap:20px; font-size:20px; color:#aaa">
                        <i class="fas fa-robot" id="ai-btn" onclick="ai.toggle()" title="AI Helper"></i>
                        <i class="fas fa-phone" onclick="calls.start(false)"></i>
                        <i class="fas fa-video" onclick="calls.start(true)"></i>
                    </div>
                </header>

                <div id="msg-feed" class="msg-container"></div>

                <div class="chat-bottom">
                    <div class="input-row">
                        <label><i class="fas fa-paperclip tool-icon"></i><input type="file" hidden onchange="msg.file(this)"></label>
                        <i class="far fa-smile tool-icon" onclick="alert('Стикеры доступны в меню +')"></i>
                        <input id="msg-in" placeholder="Сообщение..." onkeypress="msg.key(event)">
                        <i id="mic" class="fas fa-microphone tool-icon" onmousedown="voice.start()" onmouseup="voice.stop()"></i>
                        <i class="fas fa-paper-plane tool-icon" style="color:var(--primary)" onclick="msg.send()"></i>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 4. MODALS (SETTINGS & MORE) -->
    <div id="modal-overlay" class="overlay hidden" onclick="ui.closeModal()">
        
        <!-- НАСТРОЙКИ -->
        <div id="mod-settings" class="glass-panel modal-box hidden" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="ui.closeModal()">&times;</span>
            <h2 style="margin-bottom:20px">Настройки</h2>
            
            <div style="text-align:center; margin-bottom:20px">
                <img id="set-av" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary); cursor:pointer" onclick="document.getElementById('up-av').click()">
                <input type="file" id="up-av" hidden accept="image/*" onchange="ui.uploadAv(this)">
                <h3 id="set-id" style="margin-top:10px; color:var(--primary)">...</h3>
            </div>

            <div class="settings-grid">
                <div class="setting-item">
                    <span>Статус</span>
                    <select id="status-sel" style="background:#000; color:white; border:none" onchange="ui.setStatus(this.value)">
                        <option value="online">В сети</option>
                        <option value="dnd">Не беспокоить</option>
                        <option value="off">Невидимка</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span>О себе</span>
                    <input id="bio-in" placeholder="Напишите что-то..." style="background:none; border:none; color:white; text-align:right" onblur="ui.saveBio(this.value)">
                </div>
                <div class="setting-item">
                    <span>2FA Защита</span>
                    <span style="color:#00ff88">ВКЛЮЧЕНО</span>
                </div>
            </div>

            <div id="admin-tools" class="hidden" style="margin-top:20px; border-top:1px solid #333; padding-top:15px">
                <p style="color:gold; font-weight:800; font-size:12px; margin-bottom:10px">GOD MODE</p>
                <input id="adm-target" class="input-cyber" placeholder="Target ID" style="padding:10px">
                <button class="btn-cyber" style="font-size:12px; padding:10px" onclick="admin.verify()">ВЫДАТЬ ГАЛОЧКУ</button>
            </div>

            <button class="btn-cyber" style="background:var(--secondary); margin-top:20px" onclick="auth.logout()">ВЫЙТИ</button>
        </div>

        <!-- ADD FRIEND -->
        <div id="mod-add" class="glass-panel modal-box hidden" onclick="event.stopPropagation()">
            <h2>Добавить</h2>
            <input id="add-id" class="input-cyber" placeholder="ID друга">
            <button class="btn-cyber" onclick="msg.req()">ОТПРАВИТЬ</button>
        </div>

        <!-- CREATE GROUP -->
        <div id="mod-group" class="glass-panel modal-box hidden" onclick="event.stopPropagation()">
            <h2>Новая группа</h2>
            <input id="gr-name" class="input-cyber" placeholder="Название">
            <button class="btn-cyber" onclick="msg.newGroup()">СОЗДАТЬ</button>
        </div>

        <!-- INBOUND REQ -->
        <div id="mod-req" class="glass-panel modal-box hidden" onclick="event.stopPropagation()">
            <h3 style="color:var(--primary)">Заявка</h3>
            <p id="req-txt" style="margin:20px 0"></p>
            <div style="display:flex; gap:10px">
                <button class="btn-cyber" onclick="msg.ans(true)">ДА</button>
                <button class="btn-cyber" style="background:#444" onclick="msg.ans(false)">НЕТ</button>
            </div>
        </div>
    </div>

    <!-- CALL SCREEN -->
    <div id="call-screen" class="hidden" style="position:fixed; inset:0; background:#000; z-index:20000">
        <video id="rem-vid" class="v-remote" autoplay playsinline style="width:100%; height:100%; object-fit:cover"></video>
        <video id="loc-vid" class="v-local" autoplay muted playsinline style="width:120px; height:160px; position:absolute; bottom:100px; right:20px; border-radius:15px; border:2px solid var(--primary); object-fit:cover; z-index:10"></video>
        <div style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); display:flex; gap:30px; z-index:20">
            <button id="ans-btn" style="width:65px; height:65px; border-radius:50%; background:#00ff88; border:none; font-size:24px"><i class="fas fa-phone"></i></button>
            <button onclick="location.reload()" style="width:65px; height:65px; border-radius:50%; background:#ff0055; border:none; font-size:24px"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- FULLSCREEN IMG -->
    <div id="fs-view" class="overlay hidden" onclick="this.classList.add('hidden')">
        <img id="fs-img" src="" style="max-width:95%; max-height:95%; border-radius:10px; box-shadow:0 0 50px rgba(0,242,255,0.3)">
    </div>

    <script>
        // --- CONFIG ---
        const EMAIL_KEY = "_QD5eXUp0g9r3WEC-"; 
        const EMAIL_SERV = "service_tatarsms";
        const EMAIL_TEMP = "template_zxlr5as";
        const CLOUD_URL = "https://api.npoint.io/858d60f4c80351f0458b"; 

        // --- CORE FUNCTIONS ---
        function safeJSON(k, fb) { try { const d = localStorage.getItem(k); return (d&&d!=="null")?JSON.parse(d):fb; } catch(e){ return fb; } }
        
        async function cloud(mode, data) {
            try {
                if(mode==='get') { const r = await fetch(CLOUD_URL); if(r.status===404) return {users:{}}; const d = await r.json(); return d.users ? d : {users:{}}; }
                if(mode==='set') { localStorage.setItem('tat_db', JSON.stringify(data)); await fetch(CLOUD_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); }
            } catch(e) { return safeJSON('tat_db', {users:{}}); }
        }

        // --- GLOBAL STATE ---
        window.state = {
            user: safeJSON('tat_user', null),
            db: {users:{}}, friends: [], groups: [], hist: safeJSON('tat_hist', {}),
            peer: null, chat: null, tab: 'dm', pending: null, code: null, temp: null, ai: false
        };

        // --- LOADER ---
        function runLoader() {
            let p = 0; const bar = document.getElementById('load-fill');
            const i = setInterval(() => {
                p+=5; if(document.getElementById('load-fill')) document.getElementById('load-fill').style.width = p+"%";
                if(p>=100) {
                    clearInterval(i);
                    document.getElementById('loader').classList.add('hidden');
                    if(state.user) { document.getElementById('app').classList.remove('hidden'); msg.init(); }
                    else document.getElementById('auth-screen').classList.remove('hidden');
                }
            }, 50);
        }

        // --- AUTH ---
        window.auth = {
            view(v) {
                ['login','reg','code'].forEach(id => document.getElementById(`form-${id}`).classList.add('hidden'));
                document.getElementById(`form-${v}`).classList.remove('hidden');
                if(v === 'reg') {
                    const a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10);
                    state.captcha = a+b;
                    document.getElementById('captcha-label').innerText = `Проверка: ${a} + ${b} = ?`;
                }
            },
            async startReg() {
                const id = document.getElementById('r-id').value.trim();
                const em = document.getElementById('r-mail').value.trim();
                const pw = document.getElementById('r-pw').value.trim();
                if(document.getElementById('r-cap').value != state.captcha) return alert("Капча!");
                if(!id || !em || !pw) return alert("Пусто!");
                
                const db = await cloud('get');
                if(db.users[id]) return alert("ID занят");

                state.code = Math.floor(100000 + Math.random() * 900000);
                state.temp = {id, em, pw};
                
                emailjs.init(EMAIL_KEY);
                emailjs.send(EMAIL_SERV, EMAIL_TEMP, { to_email: em, message: "Код: " + state.code })
                .then(() => this.view('code'), () => { alert("Код (Test): " + state.code); this.view('code'); });
            },
            async verify() {
                if(document.getElementById('r-code').value != state.code) return alert("Неверно");
                const db = await cloud('get');
                db.users[state.temp.id] = { pw: btoa(state.temp.pw), av: `https://api.dicebear.com/7.x/bottts/svg?seed=${state.temp.id}` };
                await cloud('set', db);
                alert("Готово!"); this.view('login');
            },
            async login() {
                const id = document.getElementById('l-id').value;
                const pw = document.getElementById('l-pw').value;
                if(id==="tatar_506" && pw==="spinogrz666") return this.ok(id, "https://api.dicebear.com/7.x/bottts/svg?seed=adm", true);
                
                const db = await cloud('get');
                const u = db.users[id];
                if(u && atob(u.pw) === pw) this.ok(id, u.av, false);
                else alert("Ошибка");
            },
            ok(id, av, adm) {
                localStorage.setItem('tat_user', JSON.stringify({id, av, adm, bio:'', status:'online'}));
                location.reload();
            },
            logout() { localStorage.clear(); location.reload(); }
        };

        // --- MESSENGER ---
        window.msg = {
            async init() {
                state.friends = safeJSON(`fr_${state.user.id}`, []);
                state.groups = safeJSON(`gr_${state.user.id}`, []);
                state.peer = new Peer(state.user.id);
                state.peer.on('open', () => {
                    document.getElementById('my-av').src = state.user.av;
                    document.getElementById('my-id').innerText = state.user.id;
                    ui.list();
                });
                state.peer.on('connection', c => { c.on('data', d => this.rx(d, c.peer)); });
                state.peer.on('call', c => calls.in(c));
            },
            search(e) {
                if(e.key !== 'Enter') return;
                const q = e.target.value.trim();
                const gr = state.groups.find(g => g.name === q);
                if(gr) return ui.sel(gr.id, gr.name, gr.av);
                const c = state.peer.connect(q);
                c.on('open', () => { c.send({type:'req', from:state.user.id}); alert("Запрос отправлен!"); });
            },
            rx(d, f) {
                if(d.type === 'req') { state.pending = f; document.getElementById('req-txt').innerText = f + " хочет в друзья"; ui.modal('req'); }
                else if(d.type === 'acc') { state.friends.push(f); this.saveFr(); ui.list(); }
                else {
                    this.save(f, d, 'received');
                    if(state.ai && d.type === 'text') ai.speak(d.val);
                    // Sound effect
                    const aud = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');
                    aud.play().catch(()=>{});
                }
            },
            req() {
                const id = document.getElementById('add-id').value;
                state.peer.connect(id).on('open', function(){ this.send({type:'req', from:state.user.id}); alert("Ок"); ui.closeModal(); });
            },
            ans(ok) {
                if(ok) { state.friends.push(state.pending); this.saveFr(); ui.list(); state.peer.connect(state.pending).on('open', function(){ this.send({type:'acc'}); }); }
                ui.closeModal();
            },
            send(obj=null) {
                const val = document.getElementById('msg-in').value.trim();
                const d = obj || {type:'text', val};
                if(!d.val || !state.chat) return;
                const c = state.peer.connect(state.chat);
                c.on('open', () => { c.send(d); this.save(state.chat, d, 'sent'); if(!obj) document.getElementById('msg-in').value=''; });
                if(val.startsWith('@ai')) ai.reply(val);
            },
            file(el) {
                const f = el.files[0]; const r = new FileReader();
                r.onload = e => this.send({type: f.type.startsWith('image')?'img':'file', val:e.target.result});
                r.readAsDataURL(f);
            },
            save(id, d, dir) {
                if(!state.history[id]) state.history[id] = [];
                state.history[id].push({...d, dir, time: new Date().toLocaleTimeString().slice(0,5)});
                localStorage.setItem('tat_hist', JSON.stringify(state.history));
                if(state.chat === id) ui.chat();
            },
            saveFr() { localStorage.setItem(`fr_${state.user.id}`, JSON.stringify(state.friends)); },
            key(e) { if(e.key === 'Enter') this.send(); },
            newGroup() {
                const n = document.getElementById('gr-name').value;
                state.groups.push({id:'gr_'+Date.now(), name:n, av:`https://api.dicebear.com/7.x/initials/svg?seed=${n}`});
                localStorage.setItem(`gr_${state.user.id}`, JSON.stringify(state.groups));
                ui.closeModal(); ui.setTab('gr');
            }
        };

        // --- UI ---
        window.ui = {
            setTab(t) { state.tab = t; document.querySelectorAll('.nav-tab').forEach(e => e.classList.toggle('active', e.id === `tab-${t}`)); this.list(); },
            list() {
                const l = document.getElementById('contacts'); l.innerHTML = '';
                const items = state.tab === 'dm' ? state.friends.map(f=>({id:f, name:f, av:`https://api.dicebear.com/7.x/bottts/svg?seed=${f}`})) : state.groups;
                items.forEach(i => {
                    const d = document.createElement('div'); d.className = 'chat-item';
                    d.innerHTML = `<img src="${i.av}"><div><b>${i.name}</b></div>`;
                    d.onclick = () => this.sel(i.id, i.name, i.av);
                    l.appendChild(d);
                });
            },
            sel(id, name, av) {
                state.chat = id;
                document.getElementById('welcome').classList.add('hidden');
                document.getElementById('chat-active').classList.remove('hidden');
                document.getElementById('head-name').innerText = name;
                document.getElementById('head-av').src = av;
                if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('closed');
                this.chat();
            },
            chat() {
                const b = document.getElementById('msg-feed'); b.innerHTML = '';
                (state.history[state.chat] || []).forEach(m => {
                    const d = document.createElement('div'); d.className = `msg-row ${m.dir}`;
                    let c = m.val;
                    if(m.type === 'img') c = `<img src="${m.val}" class="media-prev" onclick="ui.view(this.src)">`;
                    if(m.type === 'voice') c = `<audio src="${m.val}" controls></audio>`;
                    d.innerHTML = `<div class="msg-box" ondblclick="this.style.border='1px solid var(--secondary)'">${c}<div style="font-size:10px; opacity:0.5; margin-top:5px">${m.time}</div></div>`;
                    b.appendChild(d);
                });
                b.scrollTop = 9999;
            },
            view(s) { document.getElementById('fs-view').classList.remove('hidden'); document.getElementById('fs-img').src = s; },
            modal(id) { 
                document.getElementById('modal-overlay').classList.remove('hidden');
                document.querySelectorAll('.modal-box').forEach(e => e.classList.add('hidden'));
                document.getElementById(`mod-${id}`).classList.remove('hidden');
                if(id === 'settings') {
                    document.getElementById('set-id').innerText = state.user.id;
                    document.getElementById('set-av').src = state.user.av;
                    document.getElementById('bio-in').value = state.user.bio || '';
                    document.getElementById('status-sel').value = state.user.status || 'online';
                    if(state.user.admin) document.getElementById('admin-tools').classList.remove('hidden');
                }
            },
            closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); },
            closeChat() { document.getElementById('chat-active').classList.add('hidden'); document.getElementById('welcome').classList.remove('hidden'); document.getElementById('sidebar').classList.remove('closed'); },
            uploadAv(el) {
                const r = new FileReader();
                r.onload = e => {
                    state.user.av = e.target.result;
                    localStorage.setItem('tat_sess', JSON.stringify(state.user));
                    location.reload();
                };
                r.readAsDataURL(el.files[0]);
            },
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('closed'); },
            toggleStickers() { document.getElementById('st-panel').classList.toggle('hidden'); },
            setStatus(v) { state.user.status = v; localStorage.setItem('tat_sess', JSON.stringify(state.user)); },
            saveBio(v) { state.user.bio = v; localStorage.setItem('tat_sess', JSON.stringify(state.user)); }
        };

        // --- FEATURES ---
        const ai = {
            toggle() { state.ai = !state.ai; document.getElementById('ai-btn').style.color = state.ai ? 'var(--ai-color)' : '#aaa'; },
            reply(txt) { setTimeout(() => { const r = "AI: Ответ сгенерирован."; msg.save(state.chat, {type:'text', val:r}, 'received'); if(state.ai) this.speak(r); }, 1000); },
            speak(t) { const u = new SpeechSynthesisUtterance(t); u.lang='ru-RU'; window.speechSynthesis.speak(u); }
        };

        const voice = {
            start() { navigator.mediaDevices.getUserMedia({audio:true}).then(s => { this.r = new MediaRecorder(s); let c=[]; this.r.ondataavailable=e=>c.push(e.data); this.r.onstop=()=>{const b=new Blob(c); const fr=new FileReader(); fr.onload=e=>msg.send({type:'voice', val:e.target.result}); fr.readAsDataURL(b);}; this.r.start(); document.getElementById('mic').classList.add('recording'); }); },
            stop() { if(this.r) { this.r.stop(); document.getElementById('mic').classList.remove('recording'); } }
        };

        const calls = {
            init(v) { navigator.mediaDevices.getUserMedia({video:v, audio:true}).then(s => { document.getElementById('call-ui').classList.remove('hidden'); document.getElementById('loc-vid').srcObject = s; const c = state.peer.call(state.chat, s); c.on('stream', rs => document.getElementById('rem-vid').srcObject = rs); }); },
            in(c) { document.getElementById('call-ui').classList.remove('hidden'); document.getElementById('ans-btn').onclick = () => { navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => { c.answer(s); document.getElementById('loc-vid').srcObject = s; c.on('stream', rs => document.getElementById('rem-vid').srcObject = rs); }); }; }
        };

        const stickers = {
            add() { const u = document.getElementById('st-url').value; if(u) { state.stickers.push(u); localStorage.setItem('tat_st', JSON.stringify(state.stickers)); this.render(); } },
            render() { 
                const g = document.getElementById('st-grid'); g.innerHTML = '';
                state.stickers.forEach(s => { const i = document.createElement('img'); i.src = s; i.onclick = () => msg.send({type:'img', val:s}); g.appendChild(i); });
            }
        };

        const admin = {
            verify() { const t = document.getElementById('adm-target').value; alert("Пользователь " + t + " верифицирован!"); }
        };

        // START
        runLoader();
    </script>

    <!-- VPN Loader Logic -->
    <script>
        function runLoader() {
            let p = 0; const bar = document.getElementById('load-fill');
            const i = setInterval(() => {
                p+=5; if(bar) bar.style.width = p+"%";
                if(p>=100) {
                    clearInterval(i);
                    document.getElementById('loader').classList.add('hidden');
                    if(state.user) { document.getElementById('app').classList.remove('hidden'); msg.init(); }
                    else document.getElementById('auth-screen').classList.remove('hidden');
                }
            }, 50);
        }
    </script>
</body>
</html>
