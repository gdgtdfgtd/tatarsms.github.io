<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tatarsms | P2P Messenger</title>
    
    <!-- –†–µ—Å—É—Ä—Å—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-darker: #1e1f22;
            --bg-sidebar: #2b2d31;
            --bg-main: #313338;
            --accent: #5865f2;
            --text-main: #dbdee1;
            --text-muted: #949ba4;
            --success: #23a55a;
            --danger: #f23f43;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-darker); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg-sidebar);
            display: flex; align-items: center; justify-content: center; z-index: 10000;
        }
        .auth-card {
            background: var(--bg-main); padding: 32px; border-radius: 8px;
            width: 100%; max-width: 420px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            text-align: center;
        }
        .avatar-picker {
            width: 100px; height: 100px; border-radius: 50%; background: var(--bg-darker);
            margin: 0 auto 20px; cursor: pointer; position: relative; overflow: hidden;
            border: 2px solid var(--accent);
        }
        .avatar-picker img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-picker i { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); opacity: 0; transition: 0.2s; }
        .avatar-picker:hover i { opacity: 1; }

        .input-group { text-align: left; margin-bottom: 20px; }
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
        .input-group input { width: 100%; background: var(--bg-darker); border: none; padding: 12px; color: white; border-radius: 4px; outline: none; }
        
        .btn-primary { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #4752c4; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- APP LAYOUT --- */
        #app { display: flex; height: 100vh; }
        .hidden { display: none !important; }

        .nav-rail { width: 72px; background: var(--bg-darker); padding: 12px 0; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .rail-icon { width: 48px; height: 48px; background: var(--bg-sidebar); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; }
        .rail-icon:hover, .rail-icon.active { border-radius: 16px; background: var(--accent); color: white; }
        .rail-icon img { width: 100%; height: 100%; border-radius: inherit; object-fit: cover; }

        .sidebar { width: 240px; background: var(--bg-sidebar); display: flex; flex-direction: column; }
        .sidebar-header { padding: 12px; font-weight: 700; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .contact-list { flex: 1; overflow-y: auto; padding: 8px; }
        .contact-card { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 4px; cursor: pointer; transition: 0.1s; }
        .contact-card:hover { background: rgba(255,255,255,0.05); }
        .contact-card.active { background: rgba(255,255,255,0.1); color: white; }
        .contact-card img { width: 32px; height: 32px; border-radius: 50%; }

        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-main); }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
        .msg { max-width: 80%; display: flex; gap: 12px; animation: msgIn 0.2s ease; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg.sent { align-self: flex-end; flex-direction: row-reverse; }
        .msg img.av { width: 40px; height: 40px; border-radius: 50%; }
        .msg-bubble { background: var(--bg-sidebar); padding: 8px 12px; border-radius: 8px; position: relative; }
        .sent .msg-bubble { background: var(--accent); color: white; }

        .input-area { padding: 16px; }
        .input-wrap { background: #383a40; border-radius: 8px; display: flex; align-items: center; padding: 0 12px; gap: 12px; }
        #msg-input { flex: 1; background: none; border: none; padding: 12px 0; color: white; outline: none; }
        
        /* --- MODALS --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: var(--bg-main); padding: 24px; border-radius: 8px; width: 400px; box-shadow: 0 24px 48px rgba(0,0,0,0.4); }

        .picker-box { position: absolute; bottom: 80px; left: 20px; background: var(--bg-sidebar); border-radius: 8px; width: 300px; padding: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); z-index: 100; }
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; font-size: 24px; max-height: 200px; overflow-y: auto; }
        .emoji-grid span { cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1>tatarsms</h1>
            <p style="color: var(--text-muted); margin-bottom: 20px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>
            
            <div class="avatar-picker" onclick="document.getElementById('file-reg').click()">
                <img id="reg-preview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=tatar">
                <i class="fas fa-camera"></i>
            </div>
            <input type="file" id="file-reg" accept="image/*" hidden onchange="handleFile(this, 'reg-preview')">

            <div class="input-group">
                <label>–í–∞—à –ù–∏–∫–Ω–µ–π–º (ID)</label>
                <input type="text" id="reg-id" placeholder="–ù–∞–ø—Ä: tatar_king">
            </div>

            <div id="admin-fields" class="hidden">
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å –ê–¥–º–∏–Ω–∞</label>
                    <input type="password" id="reg-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>

            <button class="btn-primary" id="btn-login" onclick="auth()">–í–æ–π—Ç–∏</button>
            <p style="margin-top: 15px; font-size: 12px; color: var(--text-muted); cursor: pointer;" onclick="toggleAdmin()">–Ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
            <div id="auth-error" style="color: var(--danger); font-size: 12px; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="app" class="hidden">
        <nav class="nav-rail">
            <div class="rail-icon active" onclick="switchMode('dm')"><i class="fas fa-user"></i></div>
            <div id="group-list-rail"></div>
            <div style="width: 32px; height: 2px; background: #35363c;"></div>
            <div class="rail-icon" onclick="openModal('group')"><i class="fas fa-plus"></i></div>
        </nav>

        <aside class="sidebar">
            <div class="sidebar-header">
                <span>–ß–∞—Ç—ã</span>
                <i class="fas fa-cog" style="cursor:pointer" onclick="openModal('settings')"></i>
            </div>
            <div style="padding: 10px;">
                <input type="text" id="search-peer" placeholder="ID –¥—Ä—É–≥–∞..." style="width:100%; background:var(--bg-darker); border:none; padding:8px; border-radius:4px; color:white; font-size:12px;">
            </div>
            <div class="contact-list" id="contact-list"></div>
        </aside>

        <main class="chat-main">
            <div id="chat-active" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <header class="chat-header">
                    <strong id="active-title">–ù–∏–∫–Ω–µ–π–º</strong>
                    <div style="display: flex; gap: 15px; color: var(--text-muted);">
                        <i class="fas fa-phone" style="cursor:pointer" onclick="call(false)"></i>
                        <i class="fas fa-video" style="cursor:pointer" onclick="call(true)"></i>
                    </div>
                </header>
                <div class="messages" id="messages-box"></div>
                <div class="input-area">
                    <div id="emoji-picker" class="picker-box hidden">
                        <div class="emoji-grid" id="emoji-grid"></div>
                    </div>
                    <div class="input-wrap">
                        <i class="far fa-smile" style="cursor:pointer" onclick="toggleEmoji()"></i>
                        <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
                        <i class="fas fa-paper-plane" style="cursor:pointer" onclick="sendMsg()"></i>
                    </div>
                </div>
            </div>
            <div id="chat-none" style="flex:1; display:flex; align-items:center; justify-content:center; color: var(--text-muted);">
                –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
            </div>
        </main>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ò -->
    <div id="modal-overlay" class="overlay hidden">
        <div id="modal-settings" class="modal hidden">
            <h2 style="margin-bottom: 20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="avatar-picker" onclick="document.getElementById('file-set').click()" style="width: 80px; height: 80px;">
                <img id="set-preview" src="">
                <i class="fas fa-camera"></i>
            </div>
            <input type="file" id="file-set" accept="image/*" hidden onchange="handleFile(this, 'set-preview')">
            <p style="font-size: 14px; margin-bottom: 20px; text-align: center;">–°—Ç–∞—Ç—É—Å: <span id="verif-status">–û–±—ã—á–Ω—ã–π</span></p>
            <button class="btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-primary" style="background:#4e5058; margin-top:8px;" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div id="modal-group" class="modal hidden">
            <h2 style="margin-bottom: 20px;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <div class="avatar-picker" onclick="document.getElementById('file-grp').click()" style="width: 80px; height: 80px;">
                <img id="grp-preview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=group">
                <i class="fas fa-camera"></i>
            </div>
            <input type="file" id="file-grp" accept="image/*" hidden onchange="handleFile(this, 'grp-preview')">
            <div class="input-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                <input type="text" id="grp-name" placeholder="–°—É–ø–µ—Ä —á–∞—Ç">
            </div>
            <button class="btn-primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn-primary" style="background:#4e5058; margin-top:8px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        const ADMIN_ID = "tatar_506";
        const ADMIN_PASS = "spinogrz666";

        let state = {
            id: '', avatar: '', verified: false, isAdmin: false,
            peer: null, activeChat: null,
            friends: JSON.parse(localStorage.getItem('tat_friends') || '[]'),
            groups: JSON.parse(localStorage.getItem('tat_groups') || '[]'),
            history: JSON.parse(localStorage.getItem('tat_history') || '{}')
        };

        // --- AUTH ---
        function toggleAdmin() { document.getElementById('admin-fields').classList.toggle('hidden'); }

        function handleFile(input, previewId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(previewId).src = e.target.result;
                if(previewId === 'reg-preview') state.avatar = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function auth() {
            const id = document.getElementById('reg-id').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();
            const btn = document.getElementById('btn-login');
            const err = document.getElementById('auth-error');

            if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º!");
            
            btn.disabled = true;
            btn.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";

            if (id === ADMIN_ID && pass === ADMIN_PASS) {
                state.isAdmin = true;
                state.verified = true;
            }

            state.id = id;
            if(!state.avatar) state.avatar = document.getElementById('reg-preview').src;

            state.peer = new Peer(id);

            state.peer.on('open', () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('set-preview').src = state.avatar;
                renderContacts();
                renderGroups();
                setupPeerListeners();
            });

            state.peer.on('error', (e) => {
                btn.disabled = false;
                btn.innerText = "–í–æ–π—Ç–∏";
                err.innerText = "–û—à–∏–±–∫–∞: –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º –∑–∞–Ω—è—Ç.";
            });
        }

        // --- PEER CORE ---
        function setupPeerListeners() {
            state.peer.on('connection', conn => {
                conn.on('data', data => {
                    if (data.type === 'msg') receiveMsg(conn.peer, data);
                    if (data.type === 'verify') { state.verified = true; saveSettings(); }
                });
            });
            // Incoming calls
            state.peer.on('call', call => {
                if(confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç " + call.peer)) {
                    navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(stream => {
                        call.answer(stream);
                        // Implement call modal UI if needed
                    });
                }
            });
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if(!val || !state.activeChat) return;

            const data = { type: 'msg', text: val, av: state.avatar, name: state.id };
            
            const conn = state.peer.connect(state.activeChat);
            conn.on('open', () => {
                conn.send(data);
                saveMsg(state.activeChat, data, 'sent');
                input.value = '';
                renderMessages();
            });
        }

        function receiveMsg(senderId, data) {
            saveMsg(senderId, data, 'received');
            if(!state.friends.find(f => f.id === senderId)) {
                state.friends.push({id: senderId, av: data.av});
                localStorage.setItem('tat_friends', JSON.stringify(state.friends));
                renderContacts();
            }
            if(state.activeChat === senderId) renderMessages();
        }

        function saveMsg(chatId, data, type) {
            if(!state.history[chatId]) state.history[chatId] = [];
            state.history[chatId].push({...data, type});
            localStorage.setItem('tat_history', JSON.stringify(state.history));
        }

        // --- UI ---
        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            state.friends.forEach(f => {
                const div = document.createElement('div');
                div.className = `contact-card ${state.activeChat === f.id ? 'active' : ''}`;
                div.onclick = () => selectChat(f.id);
                div.innerHTML = `<img src="${f.av || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+f.id}"> <span>${f.id}</span>`;
                list.appendChild(div);
            });
        }

        function renderGroups() {
            const rail = document.getElementById('group-list-rail');
            rail.innerHTML = '';
            state.groups.forEach(g => {
                const div = document.createElement('div');
                div.className = `rail-icon ${state.activeChat === g.id ? 'active' : ''}`;
                div.onclick = () => selectChat(g.id);
                div.innerHTML = `<img src="${g.av}">`;
                rail.appendChild(div);
            });
        }

        function selectChat(id) {
            state.activeChat = id;
            document.getElementById('chat-none').classList.add('hidden');
            document.getElementById('chat-active').classList.remove('hidden');
            document.getElementById('active-title').innerText = id;
            renderContacts();
            renderGroups();
            renderMessages();
        }

        function renderMessages() {
            const box = document.getElementById('messages-box');
            box.innerHTML = '';
            const msgs = state.history[state.activeChat] || [];
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type}`;
                div.innerHTML = `
                    <img src="${m.av}" class="av">
                    <div class="msg-bubble">
                        <div style="font-size: 11px; font-weight: 700; margin-bottom: 2px;">${m.name}</div>
                        ${m.text}
                    </div>
                `;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function toggleEmoji() {
            const p = document.getElementById('emoji-picker');
            p.classList.toggle('hidden');
            if(!p.classList.contains('hidden')) {
                const grid = document.getElementById('emoji-grid');
                grid.innerHTML = '';
                ['üòÄ','üòÇ','üòç','üî•','üôå','‚ú®','üöÄ','üéâ','üëç','‚ù§Ô∏è'].forEach(e => {
                    const s = document.createElement('span');
                    s.innerText = e;
                    s.onclick = () => { document.getElementById('msg-input').value += e; p.classList.add('hidden'); };
                    grid.appendChild(s);
                });
            }
        }

        // --- MODALS & GROUPS ---
        function openModal(id) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-' + id).classList.remove('hidden');
            if(id === 'settings') document.getElementById('verif-status').innerText = state.verified ? "–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–û–±—ã—á–Ω—ã–π";
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        }

        function saveSettings() {
            state.avatar = document.getElementById('set-preview').src;
            closeModal();
        }

        function createGroup() {
            const name = document.getElementById('grp-name').value.trim();
            const av = document.getElementById('grp-preview').src;
            if(!name) return;
            const id = 'grp_' + Date.now();
            state.groups.push({id, name, av});
            localStorage.setItem('tat_groups', JSON.stringify(state.groups));
            renderGroups();
            closeModal();
        }

        // --- SEARCH ---
        document.getElementById('search-peer').onkeypress = (e) => {
            if(e.key === 'Enter') {
                const id = e.target.value.trim();
                if(id && id !== state.id) {
                    if(!state.friends.find(f => f.id === id)) {
                        state.friends.push({id, av: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + id});
                        localStorage.setItem('tat_friends', JSON.stringify(state.friends));
                        renderContacts();
                    }
                    selectChat(id);
                    e.target.value = '';
                }
            }
        };

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
