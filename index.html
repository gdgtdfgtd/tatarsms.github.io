<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>tatarsms | System v15</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.4);
            --bg-deep: #050508;
            --glass: rgba(20, 20, 30, 0.6);
            --glass-strong: rgba(20, 20, 30, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --success: #00ff88;
            --danger: #ff3355;
            --text-muted: #888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-deep); color: white; height: 100vh; overflow: hidden; }

        /* NEBULA ANIMATION */
        .nebula {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #16213e 40%, #0f3460 70%, #000 100%);
            background-size: 200% 200%; animation: nebulaMove 20s ease infinite;
        }
        @keyframes nebulaMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .hidden { display: none !important; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(15px); opacity: 0; pointer-events: none; transition: 0.3s; }
        .overlay.active { opacity: 1; pointer-events: all; }

        /* ANIMATIONS */
        @keyframes popUp { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* UI ELEMENTS */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; background: linear-gradient(90deg, var(--accent), #0062ff); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent-glow); }
        .input-std { width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 12px; color: white; margin-bottom: 10px; transition: 0.3s; }
        .input-std:focus { border-color: var(--accent); }

        /* AUTH CARD */
        .auth-card { width: 90%; max-width: 400px; padding: 40px; border-radius: 30px; text-align: center; animation: popUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }

        /* APP LAYOUT */
        #app { display: flex; height: 100vh; opacity: 0; transition: 0.5s; }
        #app.visible { opacity: 1; }
        
        #sidebar { width: 320px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: rgba(10,10,15,0.5); transition: 0.4s; z-index: 50; }
        .side-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .me { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .me img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover; }
        
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 15px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; animation: slideIn 0.3s ease; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-item.active { background: linear-gradient(90deg, rgba(0, 242, 255, 0.1), transparent); border-left: 3px solid var(--accent); }
        .chat-item img { width: 42px; height: 42px; border-radius: 50%; background: #000; object-fit: cover; }

        /* CHAT WINDOW */
        #chat { flex: 1; display: flex; flex-direction: column; position: relative; }
        .header { height: 70px; padding: 0 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 75%; display: flex; flex-direction: column; animation: popUp 0.3s ease; }
        .msg.sent { align-self: flex-end; align-items: flex-end; }
        .bubble { padding: 12px 18px; border-radius: 20px; font-size: 15px; line-height: 1.5; background: var(--glass); border: 1px solid var(--border); position: relative; }
        .sent .bubble { background: #0044cc; border: none; border-bottom-right-radius: 4px; }
        .received .bubble { border-bottom-left-radius: 4px; }

        .chat-footer { padding: 20px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        .input-bar { background: rgba(255,255,255,0.05); border-radius: 25px; padding: 8px 20px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); }
        .input-bar input { flex: 1; background: none; border: none; color: white; font-size: 16px; }
        .icon { font-size: 20px; color: #888; cursor: pointer; transition: 0.2s; }
        .icon:hover { color: var(--accent); }

        /* SETTINGS (50 Functions Style) */
        .settings-modal { width: 95%; max-width: 600px; height: 80vh; display: flex; overflow: hidden; background: #0e0e12; }
        .set-nav { width: 180px; background: rgba(0,0,0,0.3); border-right: 1px solid var(--border); padding: 20px 10px; display: flex; flex-direction: column; gap: 5px; }
        .set-tab { padding: 12px; border-radius: 10px; cursor: pointer; color: #aaa; font-size: 14px; transition: 0.2s; }
        .set-tab:hover, .set-tab.active { background: rgba(255,255,255,0.05); color: white; }
        .set-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Media & Modals */
        .modal-base { background: #0e0e12; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); animation: popUp 0.4s; }
        .media-frame { max-width: 250px; border-radius: 15px; overflow: hidden; border: 2px solid var(--border); margin: 5px 0; cursor: pointer; }
        .media-frame img { width: 100%; display: block; }
        
        @media (max-width: 768px) {
            #sidebar { position: absolute; inset: 0; transform: translateX(0); z-index: 100; }
            #sidebar.hidden { transform: translateX(-100%); }
            .settings-modal { flex-direction: column; height: 90vh; }
            .set-nav { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; border-bottom: 1px solid var(--border); border-right: none; }
            .back-btn { display: block !important; margin-right: 15px; }
        }
        .back-btn { display: none; }
    </style>
</head>
<body>

    <div class="nebula"></div>

    <!-- AUTH -->
    <div id="auth-screen" class="overlay active">
        <div class="auth-card glass-panel">
            <h1 style="font-size:36px; margin-bottom:20px; background:linear-gradient(90deg, #fff, var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:800">tatarsms</h1>
            
            <div id="view-login">
                <input id="l-id" class="input-std" placeholder="ID">
                <input id="l-pw" type="password" class="input-std" placeholder="Пароль">
                <button class="btn" onclick="app.login()">ВОЙТИ</button>
                <p style="margin-top:20px; color:#666; font-size:12px; cursor:pointer" onclick="ui.view('reg')">Нет аккаунта?</p>
            </div>

            <div id="view-reg" class="hidden">
                <input id="r-email" class="input-std" placeholder="Email">
                <input id="r-id" class="input-std" placeholder="Новый ID">
                <input id="r-pw" type="password" class="input-std" placeholder="Пароль">
                <button class="btn" id="code-btn" onclick="app.sendCode()">КОД</button>
                <p style="margin-top:20px; color:#666; font-size:12px; cursor:pointer" onclick="ui.view('login')">Назад</p>
            </div>

            <div id="view-code" class="hidden">
                <p style="margin-bottom:15px">Код подтверждения</p>
                <input id="v-code" class="input-std" style="text-align:center; font-size:24px; letter-spacing:5px" maxlength="6">
                <button class="btn" onclick="app.verify()">ОК</button>
            </div>
            
            <div id="view-2fa" class="hidden">
                <p style="margin-bottom:15px; color:var(--accent)">2FA ЗАЩИТА</p>
                <p style="font-size:12px; color:#888; margin-bottom:10px">Введите код из письма для входа</p>
                <input id="2fa-code" class="input-std" style="text-align:center; font-size:24px;">
                <button class="btn" onclick="app.check2FA()">ВОЙТИ</button>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
        <aside id="sidebar" class="glass-panel">
            <div class="side-head">
                <div class="me" onclick="ui.openSettings()">
                    <img id="my-av" src="">
                    <div><div style="font-weight:700" id="my-id">...</div><div style="font-size:11px; color:var(--success)">Online</div></div>
                </div>
                <i class="fas fa-plus-circle" style="font-size:20px; cursor:pointer; color:#aaa" onclick="ui.modal('add')"></i>
            </div>
            <div class="chat-list" id="contact-list"></div>
        </aside>

        <main id="chat">
            <div id="chat-welcome" style="flex:1; display:flex; align-items:center; justify-content:center; flex-direction:column; opacity:0.3">
                <i class="fas fa-meteor" style="font-size:80px; margin-bottom:20px"></i>
                <h2>TATARSMS V15</h2>
            </div>
            <div id="chat-active" class="hidden" style="flex:1; display:flex; flex-direction:column; height:100%">
                <header class="header">
                    <div style="display:flex; align-items:center">
                        <i class="fas fa-arrow-left back-btn" onclick="ui.toggleSidebar()"></i>
                        <img id="target-av" src="" style="width:40px; height:40px; border-radius:50%; margin-right:12px">
                        <h4 id="target-name">...</h4>
                    </div>
                    <div style="display:flex; gap:20px; color:#aaa; font-size:18px">
                        <i class="fas fa-phone" onclick="calls.start(false)"></i>
                        <i class="fas fa-video" onclick="calls.start(true)"></i>
                    </div>
                </header>
                <div class="messages" id="msg-box"></div>
                <div class="chat-footer">
                    <div class="input-bar">
                        <i class="fas fa-paperclip icon" onclick="document.getElementById('f-up').click()"></i>
                        <input type="file" id="f-up" hidden onchange="msg.file(this)">
                        <input type="text" id="m-in" placeholder="Сообщение..." onkeypress="if(event.key=='Enter') msg.send()">
                        <i class="fas fa-microphone icon" id="mic-btn" onmousedown="voice.start()" onmouseup="voice.stop()"></i>
                        <i class="fas fa-paper-plane icon" style="color:var(--accent)" onclick="msg.send()"></i>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SETTINGS MODAL (50 Functions UI) -->
    <div id="modal-settings" class="overlay">
        <div class="settings-modal glass-panel">
            <div class="set-nav">
                <div class="set-tab active" onclick="ui.setPage('gen')">Общие</div>
                <div class="set-tab" onclick="ui.setPage('priv')">Приватность</div>
                <div class="set-tab" onclick="ui.setPage('ai')">AI & Bot</div>
                <div class="set-tab" id="adm-tab" style="display:none; color:gold" onclick="ui.setPage('adm')">GOD MODE</div>
                <div class="set-tab" style="color:var(--danger); margin-top:auto" onclick="app.logout()">Выйти</div>
                <div class="set-tab" onclick="ui.closeSettings()">Закрыть</div>
            </div>
            <div class="set-content" id="set-content">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- GENERIC MODAL -->
    <div id="modal-gen" class="overlay">
        <div class="modal-base">
            <h3 id="mod-title">Title</h3>
            <div id="mod-body"></div>
            <button class="btn" style="margin-top:20px; background:#333" onclick="ui.closeGen()">Закрыть</button>
        </div>
    </div>

    <!-- CALL UI -->
    <div id="call-ui" class="hidden" style="position:fixed; inset:0; background:#000; z-index:20000">
        <video id="rem-v" style="width:100%; height:100%; object-fit:cover" autoplay playsinline></video>
        <video id="loc-v" style="width:120px; height:160px; position:absolute; bottom:20px; right:20px; border-radius:15px; border:2px solid var(--accent); z-index:10" autoplay muted playsinline></video>
        <div style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); display:flex; gap:20px; z-index:20">
            <button onclick="calls.answer()" style="width:60px; height:60px; border-radius:50%; background:#00ff88; border:none; font-size:24px"><i class="fas fa-phone"></i></button>
            <button onclick="location.reload()" style="width:60px; height:60px; border-radius:50%; background:#ff3355; border:none; font-size:24px"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CLOUD_URL = "https://api.jsonbin.io/v3/b/65b1287b266cfc3fde7ef755";
        const CLOUD_KEY = "$2a$10$W5pXvU6f5vG7p0.fR1qEBeG7VzQvY1VzE7vE7vE7vE7vE7vE7vE7v";
        const EMAIL_KEY = "_QD5eXUp0g9r3WEC-"; 
        const EMAIL_SERV = "service_tatarsms";
        const EMAIL_TEMP = "template_zxlr5as";
        const ADMIN_ID = "tatar_506";

        // --- STATE ---
        let state = {
            user: JSON.parse(localStorage.getItem('ts_sess') || 'null'),
            settings: JSON.parse(localStorage.getItem('ts_set') || '{"2fa":false, "ai":true, "sound":true, "theme":"nebula"}'),
            db: {}, friends: [], history: {}, peer: null, chat: null, temp: null, code: null
        };

        // --- CORE FUNCTIONS ---
        const app = {
            async db(mode, data) {
                if(mode === 'get') {
                    try { const r = await fetch(CLOUD_URL+"/latest", {headers:{"X-Master-Key":CLOUD_KEY}}); const d = await r.json(); return d.record.users ? d.record : {users:{}}; }
                    catch(e) { return JSON.parse(localStorage.getItem('ts_db') || '{"users":{}}'); }
                }
                if(mode === 'set') {
                    localStorage.setItem('ts_db', JSON.stringify(data));
                    try { await fetch(CLOUD_URL, {method:'PUT', headers:{"Content-Type":"application/json", "X-Master-Key":CLOUD_KEY}, body:JSON.stringify(data)}); } catch(e){}
                }
            },
            
            async login() {
                const id = document.getElementById('l-id').value;
                const pw = document.getElementById('l-pw').value;
                if(id === ADMIN_ID && pw === "spinogrz666") return this.start(id, "https://api.dicebear.com/7.x/bottts/svg?seed=adm", true);
                
                const db = await this.db('get');
                const u = db.users[id];
                if(u && atob(u.pw) === pw) {
                    if(state.settings['2fa']) {
                        state.temp = {id, av:u.av};
                        this.sendEmail(u.email || 'mail', '2fa');
                    } else this.start(id, u.av);
                } else alert("Ошибка!");
            },

            async startReg() {
                const id = document.getElementById('r-id').value;
                const em = document.getElementById('r-email').value;
                const pw = document.getElementById('r-pw').value;
                if(!id || !em || !pw) return alert("Заполните всё");
                
                const db = await this.db('get');
                if(db.users[id]) return alert("ID занят");

                state.temp = {id, em, pw};
                this.sendEmail(em, 'reg');
            },

            sendEmail(em, type) {
                state.code = Math.floor(100000 + Math.random() * 900000);
                const btn = document.getElementById(type === 'reg' ? 'code-btn' : 'l-id'); // just anchor
                
                emailjs.init(EMAIL_KEY);
                emailjs.send(EMAIL_SERV, EMAIL_TEMP, { to_email: em, message: `Код ${type}: ${state.code}` })
                .then(() => { 
                    ui.view(type === 'reg' ? 'code' : '2fa'); 
                }, () => {
                    alert(`Ошибка почты. Код (тест): ${state.code}`);
                    ui.view(type === 'reg' ? 'code' : '2fa');
                });
            },

            async verify() {
                if(document.getElementById('v-code').value != state.code) return alert("Неверно");
                const db = await this.db('get');
                db.users[state.temp.id] = { pw: btoa(state.temp.pw), av: `https://api.dicebear.com/7.x/bottts/svg?seed=${state.temp.id}`, email: state.temp.em };
                await this.db('set', db);
                alert("Создано!"); ui.view('login');
            },

            check2FA() {
                if(document.getElementById('2fa-code').value == state.code) this.start(state.temp.id, state.temp.av);
                else alert("Неверно");
            },

            start(id, av, adm=false) {
                localStorage.setItem('ts_sess', JSON.stringify({id, av, adm}));
                location.reload();
            },
            logout() { localStorage.removeItem('ts_sess'); location.reload(); }
        };

        const msg = {
            init() {
                state.friends = JSON.parse(localStorage.getItem(`fr_${state.user.id}`) || '[]');
                state.history = JSON.parse(localStorage.getItem('ts_hist') || '{}');
                state.peer = new Peer(state.user.id);
                
                state.peer.on('open', () => {
                    document.getElementById('auth-screen').classList.remove('active'); // Hide overlay
                    document.getElementById('app').classList.add('visible');
                    document.getElementById('my-av').src = state.user.av;
                    document.getElementById('my-id').innerText = state.user.id;
                    ui.renderList();
                });
                state.peer.on('connection', c => { c.on('data', d => this.rx(d, c.peer)); });
                state.peer.on('call', c => calls.in(c));
            },
            rx(d, f) {
                if(d.type === 'req') {
                    if(confirm(`Запрос в друзья от ${f}`)) {
                        state.friends.push(f);
                        localStorage.setItem(`fr_${state.user.id}`, JSON.stringify(state.friends));
                        ui.renderList();
                    }
                } else {
                    this.save(f, d, 'received');
                    if(state.settings.ai && d.type === 'text' && d.val.includes('@ai')) ai.reply(d.val);
                }
            },
            send(obj) {
                const val = document.getElementById('m-in').value;
                const d = obj || {type:'text', val};
                if(!d.val || !state.chat) return;
                const c = state.peer.connect(state.chat);
                c.on('open', () => { c.send(d); this.save(state.chat, d, 'sent'); if(!obj) document.getElementById('m-in').value=''; });
            },
            file(el) {
                const f = el.files[0]; const r = new FileReader();
                r.onload = e => this.send({type: f.type.startsWith('image')?'img':'file', val:e.target.result});
                r.readAsDataURL(f);
            },
            save(id, d, dir) {
                if(!state.history[id]) state.history[id] = [];
                state.history[id].push({...d, dir, time: new Date().toLocaleTimeString().slice(0,5)});
                localStorage.setItem('ts_hist', JSON.stringify(state.history));
                if(state.chat === id) ui.renderChat();
            },
            req() {
                const id = document.getElementById('add-inp').value;
                const c = state.peer.connect(id);
                c.on('open', () => { c.send({type:'req'}); alert("Отправлено!"); ui.closeGen(); });
            }
        };

        const ui = {
            view(v) {
                ['login','reg','code','2fa'].forEach(id => document.getElementById(`view-${id}`).classList.add('hidden'));
                document.getElementById(`view-${v}`).classList.remove('hidden');
            },
            renderList() {
                const l = document.getElementById('contact-list'); l.innerHTML = '';
                state.friends.forEach(id => {
                    const d = document.createElement('div'); d.className = 'chat-item';
                    d.innerHTML = `<img src="https://api.dicebear.com/7.x/bottts/svg?seed=${id}"><span>${id}</span>`;
                    d.onclick = () => this.select(id);
                    l.appendChild(d);
                });
            },
            select(id) {
                state.chat = id;
                document.getElementById('chat-active').classList.remove('hidden');
                document.getElementById('chat-welcome').classList.add('hidden');
                document.getElementById('target-name').innerText = id;
                document.getElementById('target-av').src = `https://api.dicebear.com/7.x/bottts/svg?seed=${id}`;
                if(window.innerWidth < 768) document.getElementById('sidebar').style.transform = 'translateX(-100%)';
                this.renderChat();
            },
            renderChat() {
                const b = document.getElementById('msg-box'); b.innerHTML = '';
                (state.history[state.chat] || []).forEach(m => {
                    const d = document.createElement('div'); d.className = `msg ${m.dir}`;
                    let c = m.val;
                    if(m.type === 'img') c = `<img src="${m.val}" style="max-width:200px; border-radius:10px">`;
                    if(m.type === 'voice') c = `<audio src="${m.val}" controls></audio>`;
                    d.innerHTML = `<div class="bubble">${c}</div>`;
                    b.appendChild(d);
                });
                b.scrollTop = 99999;
            },
            openSettings() {
                document.getElementById('modal-settings').classList.remove('hidden');
                document.getElementById('modal-settings').classList.add('active');
                if(state.user.adm) document.getElementById('adm-tab').style.display = 'block';
                this.setPage('gen');
            },
            closeSettings() { document.getElementById('modal-settings').classList.add('hidden'); },
            setPage(p) {
                const c = document.getElementById('set-content');
                if(p === 'gen') c.innerHTML = `<h3>Аккаунт</h3><p>ID: ${state.user.id}</p><br><div class="toggle-row"><span>Включить 2FA</span><label class="switch"><input type="checkbox" id="t-2fa" onchange="ui.saveSet()"><span class="slider"></span></label></div>`;
                if(p === 'ai') c.innerHTML = `<h3>AI Настройки</h3><div class="toggle-row"><span>AI Бот (@ai)</span><label class="switch"><input type="checkbox" id="t-ai" onchange="ui.saveSet()"><span class="slider"></span></label></div>`;
                if(p === 'adm') c.innerHTML = `<h3>GOD MODE</h3><input id="adm-in" class="input-std" placeholder="Target"><button class="btn" onclick="admin.ban()">BAN HWID</button><button class="btn" style="margin-top:5px; background:red" onclick="admin.wipe()">WIPE DB</button>`;
                
                // Load states
                if(p === 'gen' && state.settings['2fa']) document.getElementById('t-2fa').checked = true;
                if(p === 'ai' && state.settings['ai']) document.getElementById('t-ai').checked = true;
            },
            saveSet() {
                if(document.getElementById('t-2fa')) state.settings['2fa'] = document.getElementById('t-2fa').checked;
                if(document.getElementById('t-ai')) state.settings['ai'] = document.getElementById('t-ai').checked;
                localStorage.setItem('ts_set', JSON.stringify(state.settings));
            },
            modal(t) {
                document.getElementById('modal-gen').classList.remove('hidden');
                document.getElementById('modal-gen').classList.add('active');
                const b = document.getElementById('mod-body');
                if(t === 'add') {
                    document.getElementById('mod-title').innerText = "Добавить";
                    b.innerHTML = `<input id="add-inp" class="input-std" placeholder="ID"><button class="btn" onclick="msg.req()">OK</button>`;
                }
            },
            closeGen() { document.getElementById('modal-gen').classList.add('hidden'); },
            toggleSidebar() { 
                const s = document.getElementById('sidebar');
                s.style.transform = s.style.transform === 'translateX(0px)' ? 'translateX(-100%)' : 'translateX(0px)';
            }
        };

        const ai = {
            reply(txt) {
                setTimeout(() => {
                    const r = "AI: Система стабильна. Я здесь.";
                    msg.save(state.chat, {type:'text', val: r}, 'received');
                }, 1000);
            }
        };

        const voice = {
            start() { navigator.mediaDevices.getUserMedia({audio:true}).then(s => { this.r = new MediaRecorder(s); let c=[]; this.r.ondataavailable=e=>c.push(e.data); this.r.onstop=()=>{const b=new Blob(c); const fr=new FileReader(); fr.onload=e=>msg.send({type:'voice', val:e.target.result}); fr.readAsDataURL(b);}; this.r.start(); }); },
            stop() { if(this.r) this.r.stop(); }
        };

        const calls = {
            init(v) {
                navigator.mediaDevices.getUserMedia({video:v, audio:true}).then(s => {
                    document.getElementById('call-ui').classList.remove('hidden');
                    document.getElementById('loc-v').srcObject = s;
                    const c = state.peer.call(state.chat, s);
                    c.on('stream', rs => document.getElementById('rem-v').srcObject = rs);
                });
            },
            in(c) {
                document.getElementById('call-ui').classList.remove('hidden');
                navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(s => {
                    c.answer(s);
                    c.on('stream', rs => document.getElementById('rem-v').srcObject = rs);
                });
            }
        };

        const admin = {
            async wipe() { if(confirm("Стереть всю базу?")) { await cloudSet({users:{}}); alert("Wiped"); } },
            ban() { alert("Banned locally"); }
        };

        // START
        if(state.user) msg.init();
        else document.getElementById('auth-screen').classList.add('active');

    </script>
</body>
</html>
